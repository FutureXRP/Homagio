<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
  <title>Homagio — My Houses</title>
  <meta name="color-scheme" content="dark" />
  <meta name="theme-color" content="#07090d" />

  <!-- ✅ FIX: correct DB file -->
  <script src="assets.db.js"></script>

  <style>
    :root{
      color-scheme: dark;
      --bg0:#07090d; --bg1:#0b0f16; --bg2:#0e1320;
      --text:#e9eef7; --muted:#b7c0d6; --muted2:#8a94ab;
      --shadow: 0 12px 40px rgba(0,0,0,.55);
      --blue:#2d6cdf; --blue2:#1f4fb0; --green:#1fbf6a;
      --max: 980px;
    }
    *{box-sizing:border-box}
    html,body{height:100%;margin:0}
    body{
      font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial;
      background:
        radial-gradient(1200px 700px at 20% 10%, rgba(45,108,223,.18), transparent 60%),
        radial-gradient(900px 600px at 85% 30%, rgba(31,191,106,.12), transparent 55%),
        linear-gradient(180deg, var(--bg0), var(--bg1) 35%, var(--bg2));
      color:var(--text);
    }
    a{color:inherit;text-decoration:none}
    .wrap{max-width:var(--max);margin:0 auto;padding:14px}
    .top{
      display:flex;align-items:center;justify-content:space-between;gap:12px;
      padding:10px 0;
    }
    .brand{display:flex;gap:10px;align-items:center;font-weight:900}
    .logo{
      width:36px;height:36px;border-radius:14px;
      background:
        radial-gradient(circle at 30% 20%, rgba(255,255,255,.25), transparent 40%),
        linear-gradient(180deg, rgba(45,108,223,.95), rgba(31,79,176,.95));
      box-shadow: 0 0 0 6px rgba(45,108,223,.22), 0 14px 34px rgba(0,0,0,.45);
      display:grid;place-items:center;
    }
    .logo:before{content:"H";font-weight:1000}
    .nav{display:flex;gap:10px;flex-wrap:wrap;justify-content:flex-end}
    .pill{
      padding:10px 12px;border-radius:999px;border:1px solid rgba(255,255,255,.12);
      background: rgba(255,255,255,.03);
      color:var(--muted);
      font-weight:800;
      font-size:13px;
    }
    .pill:hover{background: rgba(255,255,255,.06); color:var(--text)}
    .pill.primary{
      border-color: rgba(45,108,223,.45);
      background: linear-gradient(180deg, rgba(45,108,223,.85), rgba(31,79,176,.85));
      color:#fff;
    }

    .panel{
      background: rgba(255,255,255,.05);
      border: 1px solid rgba(255,255,255,.10);
      border-radius: 22px;
      padding: 16px;
      box-shadow: var(--shadow);
    }

    .row{
      display:flex;align-items:center;justify-content:space-between;
      gap:10px;padding:12px 10px;border-radius:16px;
      border:1px solid rgba(255,255,255,.08);
      background: rgba(0,0,0,.18);
      margin-bottom:10px;
    }
    .row b{display:block;white-space:nowrap;overflow:hidden;text-overflow:ellipsis;max-width:420px}
    .row small{display:block;color:var(--muted2);margin-top:3px}
    .right{display:flex;gap:8px;align-items:center}

    .btn{
      display:inline-flex;align-items:center;justify-content:center;
      padding:10px 12px;border-radius:14px;
      border:1px solid rgba(255,255,255,.12);
      background: rgba(255,255,255,.04);
      font-weight:900;font-size:13px;
      cursor:pointer;
      user-select:none;
    }
    .btn:hover{background: rgba(255,255,255,.07)}
    .btn.primary{
      border-color: rgba(45,108,223,.45);
      background: linear-gradient(180deg, rgba(45,108,223,.92), rgba(31,79,176,.92));
      color:#fff;
    }
    .btn.danger{
      border-color: rgba(255,90,90,.35);
      background: rgba(255,90,90,.10);
      color:#ffd9d9;
    }
    .btn:disabled{opacity:.65;cursor:not-allowed}

    .grid2{display:grid;grid-template-columns:1fr 1fr;gap:10px}
    @media (max-width: 720px){ .grid2{grid-template-columns:1fr} }

    .field label{display:block;font-size:12px;color:var(--muted);font-weight:900;margin-bottom:6px}
    .field input{
      width:100%;
      padding:12px 12px;
      border-radius:14px;
      border:1px solid rgba(255,255,255,.12);
      background: rgba(0,0,0,.22);
      color:var(--text);
      outline:none;
    }
    .field input:focus{border-color: rgba(45,108,223,.55)}
    .hint{font-size:12px;color:var(--muted2);margin-top:6px;line-height:1.35}
    details.advanced{margin-top:12px;padding:10px 12px;border:1px solid rgba(255,255,255,.08);border-radius:14px;background:rgba(255,255,255,.03)}
    details.advanced summary{cursor:pointer;color:var(--muted);font-weight:700}

    .sp{height:12px}
    h2{margin:0 0 10px}
  </style>
</head>
<body>
  <div class="wrap">
    <div class="top">
      <a class="brand" href="index.html">
        <div class="logo" aria-hidden="true"></div>
        <div>Homagio</div>
      </a>
      <div class="nav">
        <a class="pill" href="index.html">Home</a>
        <a class="pill primary" href="my.html">My Houses</a>
        <a class="pill" href="explore.html">Explore</a>
      </div>
    </div>

    <div class="panel">
      <h2>My Houses</h2>
      <div id="homesList"></div>

      <div class="sp"></div>
      <div class="right" style="justify-content:flex-start;flex-wrap:wrap">
        <button class="btn" onclick="openFirstOrCreate()">Open first house</button>
        <button class="btn danger" onclick="resetDemo()">Reset demo data</button>
      </div>

      <div class="sp"></div>
      <div style="border-top:1px solid rgba(255,255,255,.10);margin:14px 0"></div>

      <div>
        <h2>Create a new house</h2>

        <div class="grid2">
          <div class="field">
            <label>Name</label>
            <input id="hn" placeholder="My House" />
          </div>
          <div class="field">
            <label>Style</label>
            <input id="hs" placeholder="Modern" />
          </div>
          <div class="field">
            <label>Tier</label>
            <input id="ht" placeholder="Free / Premium" />
          </div>
        </div>

        <div class="field" style="margin-top:10px">
          <label>Address</label>
          <input id="haddr" placeholder="123 Main St, Tulsa, OK" />
          <div class="hint">We’ll convert this address into a map pin automatically.</div>
        </div>

        <details class="advanced">
          <summary>Advanced: enter latitude/longitude manually</summary>
          <div class="grid2" style="margin-top:10px">
            <div class="field">
              <label>Latitude</label>
              <input id="hlat" placeholder="36.15398" />
            </div>
            <div class="field">
              <label>Longitude</label>
              <input id="hlng" placeholder="-95.99277" />
            </div>
          </div>
          <div class="hint">If you enter lat/lng here, it will override geocoding.</div>
        </details>

        <div class="sp"></div>
        <button id="createBtn" class="btn primary" onclick="addHouse()">Create House</button>
      </div>
    </div>
  </div>

<script>
  // Ensure demo exists at least once
  HomagioDB.seedDemoNear(36.15398, -95.99277, false);
  render();

  function render(){
    const list = document.getElementById("homesList");
    const houses = HomagioDB.getAllHouses()
      .sort((a,b)=> (b.updated||"").localeCompare(a.updated||""));

    if(!houses.length){
      list.innerHTML = `<div style="color:rgba(255,255,255,.7);padding:10px">
        No houses yet. Create one below or reset demo.
      </div>`;
      return;
    }

    list.innerHTML = houses.map(h => {
      const updated = h.updated ? new Date(h.updated).toLocaleString() : "—";
      const name = esc(h.name || "House");
      const style = esc(h.style || "");
      const tier = esc(h.tier || "");
      const addr = esc(h.address?.formatted || h.address?.raw || "");
      return `
        <div class="row">
          <div style="min-width:0">
            <b title="${name}">${name}</b>
            <small>${style} • ${tier} • ${addr ? addr + " • " : ""}Updated ${updated}</small>
          </div>
          <div class="right">
            <a class="btn" href="house.html?id=${encodeURIComponent(h.id)}&mode=view">View</a>
            <a class="btn primary" href="house.html?id=${encodeURIComponent(h.id)}&mode=edit">Edit</a>
          </div>
        </div>
      `;
    }).join("");
  }

  function openFirstOrCreate(){
    const houses = HomagioDB.getAllHouses();
    if(houses.length){
      window.location.href = `house.html?id=${encodeURIComponent(houses[0].id)}&mode=edit`;
    } else {
      alert("Create a house first (or tap Reset Demo).");
    }
  }

  function toast(msg){
    const el = document.createElement("div");
    el.textContent = msg;
    el.style.position = "fixed";
    el.style.left = "50%";
    el.style.bottom = "18px";
    el.style.transform = "translateX(-50%)";
    el.style.background = "rgba(0,0,0,.78)";
    el.style.border = "1px solid rgba(255,255,255,.14)";
    el.style.color = "#fff";
    el.style.padding = "10px 12px";
    el.style.borderRadius = "14px";
    el.style.boxShadow = "0 18px 50px rgba(0,0,0,.55)";
    el.style.zIndex = "9999";
    el.style.maxWidth = "min(520px, calc(100vw - 24px))";
    el.style.fontSize = "13px";
    el.style.textAlign = "center";
    document.body.appendChild(el);
    setTimeout(()=>{ el.style.opacity = "0"; el.style.transition="opacity .25s ease"; }, 2400);
    setTimeout(()=>{ el.remove(); }, 2800);
  }

  async function geocodeAddress(q){
    const url = "https://nominatim.openstreetmap.org/search?format=json&limit=1&addressdetails=1&q=" + encodeURIComponent(q);
    const res = await fetch(url, { headers: { "Accept": "application/json" } });
    if(!res.ok) throw new Error("Geocode failed");
    const data = await res.json();
    if(!Array.isArray(data) || !data.length) return null;
    const hit = data[0];
    const lat = hit.lat ? parseFloat(hit.lat) : null;
    const lng = hit.lon ? parseFloat(hit.lon) : null;
    const formatted = hit.display_name || q;
    return { lat, lng, formatted };
  }

  function setCreateBusy(on){
    const btn = document.getElementById("createBtn");
    if(!btn) return;
    btn.disabled = !!on;
    btn.textContent = on ? "Creating…" : "Create House";
  }

  async function addHouse(){
    const name = document.getElementById("hn").value.trim() || "New House";
    const style = document.getElementById("hs").value.trim() || "Modern";
    const tier = document.getElementById("ht").value.trim() || "Free";

    const addressRaw = (document.getElementById("haddr")?.value || "").trim();

    // Optional manual override
    const latStr = (document.getElementById("hlat")?.value || "").trim();
    const lngStr = (document.getElementById("hlng")?.value || "").trim();
    const hasManual = latStr !== "" && lngStr !== "" && !Number.isNaN(parseFloat(latStr)) && !Number.isNaN(parseFloat(lngStr));

    let lat = null, lng = null, addressFormatted = addressRaw;

    try{
      setCreateBusy(true);

      if(hasManual){
        lat = parseFloat(latStr);
        lng = parseFloat(lngStr);
      } else if(addressRaw){
        const geo = await geocodeAddress(addressRaw);
        if(geo){
          lat = geo.lat;
          lng = geo.lng;
          addressFormatted = geo.formatted || addressRaw;
        } else {
          // No results — allow saving anyway
          toast("Couldn’t find that address. Saved without a map pin.");
        }
      } else {
        // No address — allow saving, but map pin will be missing
        toast("Tip: add an address so it shows up on Explore.");
      }

      const id = HomagioDB.uid("house");
      const house = {
        id,
        ownerId: "local-owner",
        name, style, tier,
        lat, lng,
        address: {
          raw: addressRaw,
          formatted: addressFormatted || addressRaw,
          line1: "",
          city: "",
          state: "",
          zip: "",
          country: ""
        },
        updated: new Date().toISOString(),
        budget: { total: 0, spent: 0 },
        items: {},
        photos: []
      };

      HomagioDB.upsertHouse(house);

      // Clear inputs
      document.getElementById("hn").value = "";
      document.getElementById("hs").value = "";
      document.getElementById("ht").value = "";
      if(document.getElementById("haddr")) document.getElementById("haddr").value = "";
      if(document.getElementById("hlat")) document.getElementById("hlat").value = "";
      if(document.getElementById("hlng")) document.getElementById("hlng").value = "";

      render();
      window.location.href = `house.html?id=${encodeURIComponent(id)}&mode=edit`;
    } catch(e){
      console.warn(e);
      toast("Create failed. Try again (or save with manual lat/lng).");
    } finally {
      setCreateBusy(false);
    }
  }

  function resetDemo(){
    if(!confirm("Reset demo data? This will replace all houses in local storage.")) return;
    HomagioDB.reset();
    HomagioDB.seedDemoNear(36.15398, -95.99277, true);
    render();
  }

  function esc(s){
    return String(s ?? "")
      .replaceAll("&","&amp;")
      .replaceAll("<","&lt;")
      .replaceAll(">","&gt;")
      .replaceAll('"',"&quot;")
      .replaceAll("'","&#039;");
  }
</script>
</body>
</html>
