<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
  <title>Homagio — House</title>
  <meta name="color-scheme" content="light dark" />
  <style>
    :root{
      --bg0:#07090d;
      --bg1:#0b0f16;
      --muted:#a9b4c7;
      --text:#eaf0ff;
      --line:rgba(255,255,255,.10);
      --blue:#2d6cdf;
      --blue2:#1f4fb0;
      --good:#27c7a8;
      --warn:#ffcc66;
      --bad:#ff5577;
      --r:18px;
    }
    *{box-sizing:border-box}
    body{
      margin:0;
      font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial;
      background: radial-gradient(1200px 600px at 25% -10%, rgba(45,108,223,.22), transparent 60%),
                  radial-gradient(900px 500px at 90% 0%, rgba(39,199,168,.16), transparent 60%),
                  linear-gradient(180deg, var(--bg0), var(--bg1));
      color:var(--text);
      min-height:100vh;
    }
    a{color:inherit;text-decoration:none}
    .top{
      position:sticky; top:0; z-index:30;
      backdrop-filter: blur(10px);
      background: rgba(7,9,13,.72);
      border-bottom:1px solid var(--line);
    }
    .wrap{max-width:1100px;margin:0 auto;padding:14px 16px}
    .row{display:flex;gap:12px;align-items:center;justify-content:space-between;flex-wrap:wrap}
    .brand{display:flex;gap:10px;align-items:center}
    .logo{
      width:34px;height:34px;border-radius:12px;
      background: radial-gradient(circle at 30% 20%, rgba(255,255,255,.20), transparent 45%),
                  linear-gradient(180deg, rgba(45,108,223,.95), rgba(31,79,176,.95));
      box-shadow: 0 0 0 6px rgba(45,108,223,.18), 0 18px 40px rgba(0,0,0,.45);
    }
    .brand h1{font-size:14px;margin:0;letter-spacing:.3px}
    .brand p{margin:0;font-size:12px;color:var(--muted)}
    .nav{display:flex;gap:10px;align-items:center;flex-wrap:wrap}
    .btn{
      border:1px solid var(--line);
      background: rgba(255,255,255,.06);
      color:var(--text);
      padding:10px 12px;
      border-radius: 14px;
      font-size:13px;
      cursor:pointer;
      transition:.15s transform,.15s background,.15s border;
    }
    .btn:hover{transform: translateY(-1px); background: rgba(255,255,255,.10); border-color: rgba(255,255,255,.16)}
    .btn.primary{
      border:none;
      background: linear-gradient(180deg, rgba(45,108,223,.95), rgba(31,79,176,.95));
      box-shadow: 0 12px 30px rgba(45,108,223,.28);
    }

    .grid{
      max-width:1100px;
      margin:0 auto;
      padding:18px 16px 50px;
      display:grid;
      grid-template-columns: 1.15fr .85fr;
      gap:14px;
    }
    @media (max-width: 980px){
      .grid{grid-template-columns:1fr}
    }

    .card{
      background: linear-gradient(180deg, rgba(255,255,255,.06), rgba(255,255,255,.03));
      border:1px solid var(--line);
      border-radius: var(--r);
      box-shadow: 0 18px 55px rgba(0,0,0,.35);
      overflow:hidden;
    }
    .hd{padding:14px 14px 10px;border-bottom:1px solid var(--line)}
    .t{font-weight:800;font-size:14px;margin:0}
    .s{margin:6px 0 0;font-size:12px;color:var(--muted);line-height:1.35}
    .bd{padding:14px}

    .seg{display:flex;gap:8px;flex-wrap:wrap;margin-top:10px}
    .chip{
      padding:8px 10px;
      border-radius: 999px;
      border:1px solid var(--line);
      background: rgba(255,255,255,.04);
      font-size:12px;
      color: var(--muted);
      cursor:pointer;
    }
    .chip.active{
      color: var(--text);
      border-color: rgba(45,108,223,.55);
      background: rgba(45,108,223,.18);
    }

    .photos{
      display:grid;
      grid-template-columns: repeat(3, 1fr);
      gap:10px;
    }
    @media (max-width: 700px){
      .photos{grid-template-columns: repeat(2, 1fr)}
    }
    .ph{
      border:1px solid var(--line);
      border-radius: 16px;
      overflow:hidden;
      background: rgba(0,0,0,.16);
      cursor:pointer;
    }
    .ph img{
      width:100%;
      height:120px;
      object-fit:cover;
      display:block;
    }
    .ph .cap{padding:8px 10px;font-size:12px;color:var(--muted);line-height:1.25}
    .ph.active{border-color: rgba(45,108,223,.65); box-shadow: 0 0 0 4px rgba(45,108,223,.12)}

    .item{
      border:1px solid var(--line);
      background: rgba(0,0,0,.18);
      border-radius: 16px;
      padding:12px;
      margin-bottom:10px;
    }
    .item .name{font-weight:800}
    .item .meta{font-size:12px;color:var(--muted);margin-top:6px;line-height:1.35}
    .item a{color: rgba(234,240,255,.95); text-decoration: underline; word-break: break-word}

    .kpis{display:grid;grid-template-columns:1fr 1fr 1fr;gap:10px;margin-top:10px}
    .kpi{
      border:1px solid var(--line);
      background: rgba(255,255,255,.04);
      padding:10px;
      border-radius: 16px;
    }
    .kpi .l{font-size:11px;color:var(--muted)}
    .kpi .v{font-size:14px;font-weight:900;margin-top:6px}
    label{font-size:12px;color:var(--muted)}
    input, select, textarea{
      width:100%;
      padding:12px 12px;
      border-radius: 14px;
      border:1px solid var(--line);
      background: rgba(0,0,0,.22);
      color: var(--text);
      outline:none;
    }
    textarea{min-height:80px; resize:vertical}
    input:focus, select:focus, textarea:focus{border-color: rgba(45,108,223,.65); box-shadow: 0 0 0 4px rgba(45,108,223,.15)}
    .row2{display:flex;gap:10px}
    .row2 > *{flex:1}
    .small{font-size:12px;color:var(--muted);line-height:1.35}
    .hr{height:1px;background:var(--line);margin:12px 0}
  </style>
</head>
<body>
  <div class="top">
    <div class="wrap">
      <div class="row">
        <div class="brand">
          <div class="logo"></div>
          <div>
            <h1 id="houseTitle">House</h1>
            <p id="houseSub">Mode: View</p>
          </div>
        </div>

        <div class="nav">
          <a class="btn" href="./my.html">← Back</a>
          <a class="btn" href="./explore.html">Explore</a>
          <button class="btn primary" id="btnEditToggle">Edit: off</button>
        </div>
      </div>
    </div>
  </div>

  <div class="grid">
    <div class="card">
      <div class="hd">
        <div class="t">Photos</div>
        <div class="s">Select a photo to view linked materials & purchase links.</div>
        <div class="seg">
          <div class="chip active" id="chipInterior">Interior</div>
          <div class="chip" id="chipExterior">Exterior</div>
        </div>
      </div>
      <div class="bd">
        <div id="photos" class="photos"></div>
        <div id="noPhotos" class="small" style="display:none;margin-top:10px">No photos yet.</div>

        <div class="hr"></div>

        <div class="t" style="font-size:13px">Linked items</div>
        <div class="small" style="margin-top:6px">Tap a photo above to see its linked materials and items.</div>
        <div style="height:12px"></div>
        <div id="items"></div>
        <div id="noItems" class="small" style="display:none">Select a photo to view its linked materials and items.</div>
      </div>
    </div>

    <div class="card">
      <div class="hd">
        <div class="t">Budget</div>
        <div class="s">Track total vs spent (local MVP).</div>
      </div>
      <div class="bd">
        <div class="kpis" id="kpis"></div>

        <div class="hr"></div>

        <div class="t" style="font-size:13px">Add Photo</div>
        <div class="small" style="margin-top:6px">Paste an image URL (MVP). Later we’ll support uploads.</div>
        <div style="height:10px"></div>

        <label>Section</label>
        <select id="photoSection">
          <option value="interior">Interior</option>
          <option value="exterior">Exterior</option>
        </select>
        <div style="height:10px"></div>

        <label>Image URL</label>
        <input id="photoUrl" placeholder="https://…" />
        <div style="height:10px"></div>

        <label>Caption</label>
        <input id="photoCaption" placeholder="e.g., Kitchen backsplash" />
        <div style="height:10px"></div>

        <button class="btn primary" id="addPhotoBtn">Add Photo</button>

        <div class="hr"></div>

        <div class="t" style="font-size:13px">Add Item / Material</div>
        <div class="small" style="margin-top:6px">Links can be tied to a selected photo, or stored unlinked.</div>
        <div style="height:10px"></div>

        <label>Title</label>
        <input id="itTitle" placeholder="e.g., Paint — Simply White" />
        <div style="height:10px"></div>

        <div class="row2">
          <div>
            <label>Category</label>
            <input id="itCategory" placeholder="Paint / Flooring / Fixture" />
          </div>
          <div>
            <label>Price</label>
            <input id="itPrice" type="number" min="0" step="0.01" placeholder="62" />
          </div>
        </div>
        <div style="height:10px"></div>

        <div class="row2">
          <div>
            <label>Brand</label>
            <input id="itBrand" placeholder="Brand" />
          </div>
          <div>
            <label>Finish</label>
            <input id="itFinish" placeholder="Matte / Satin / Eggshell" />
          </div>
        </div>
        <div style="height:10px"></div>

        <label>Purchase link</label>
        <input id="itLink" placeholder="https://…" />
        <div style="height:10px"></div>

        <label>Notes</label>
        <textarea id="itNotes" placeholder="Any notes…"></textarea>
        <div style="height:10px"></div>

        <button class="btn primary" id="addItemBtn">+ Link item</button>

        <div class="hr"></div>

        <button class="btn" id="exportBtn">Export PDF (stub)</button>
        <div class="small" style="margin-top:8px">
          PDF export is a placeholder in the static site. We can wire a real export next (html2pdf / jsPDF).
        </div>
      </div>
    </div>
  </div>

  <script src="./assets/db.js"></script>
  <script>
    const $ = (id) => document.getElementById(id);

    const params = new URLSearchParams(location.search);
    const houseId = params.get("id");

    let modeEdit = false;
    let filterSection = "interior"; // interior | exterior
    let selectedPhotoId = null;

    function escapeHtml(str){
      return String(str || "")
        .replaceAll("&","&amp;")
        .replaceAll("<","&lt;")
        .replaceAll(">","&gt;")
        .replaceAll('"',"&quot;")
        .replaceAll("'","&#039;");
    }
    function escapeAttr(str){
      return String(str || "").replaceAll('"',"&quot;");
    }
    function money(n){
      const v = Number(n || 0);
      return "$" + v.toLocaleString(undefined, { maximumFractionDigits: 0 });
    }

    function loadHouse(){
      const h = HomagioDB.getHouse(houseId);
      if(!h){
        $("houseTitle").textContent = "House not found";
        $("houseSub").textContent = "Go back and create a house first.";
        return null;
      }
      $("houseTitle").textContent = h.name || "House";
      $("houseSub").textContent = (modeEdit ? "Mode: Edit" : "Mode: View") + (h.address ? " • " + h.address : "");
      return h;
    }

    function renderBudget(h){
      const total = Number(h.budgetTotal || 0);
      const spent = Number(h.budgetSpent || 0);
      const remaining = total - spent;
      $("kpis").innerHTML = `
        <div class="kpi"><div class="l">Total</div><div class="v">${money(total)}</div></div>
        <div class="kpi"><div class="l">Spent</div><div class="v">${money(spent)}</div></div>
        <div class="kpi"><div class="l">Remaining</div><div class="v">${money(remaining)}</div></div>
      `;
    }

    function renderPhotos(h){
      const list = (h.photos || []).filter(p => (p.section || "interior") === filterSection);
      const wrap = $("photos");
      wrap.innerHTML = "";

      $("noPhotos").style.display = list.length ? "none" : "block";

      list.forEach((p)=>{
        const div = document.createElement("div");
        div.className = "ph" + (p.id === selectedPhotoId ? " active" : "");
        div.innerHTML = `
          <img src="${escapeAttr(p.url)}" alt="" />
          <div class="cap">${escapeHtml(p.caption || "Photo")}</div>
        `;
        div.addEventListener("click", ()=>{
          selectedPhotoId = p.id;
          renderPhotos(loadHouse());
          renderItems(loadHouse());
        });
        wrap.appendChild(div);
      });

      // Auto-select first if none
      if(!selectedPhotoId && list[0]){
        selectedPhotoId = list[0].id;
        renderItems(h);
        renderPhotos(h);
      }
    }

    function renderItems(h){
      const itemsWrap = $("items");
      itemsWrap.innerHTML = "";

      const items = Array.isArray(h.items) ? h.items : [];
      const linked = selectedPhotoId ? items.filter(it => it.photoId === selectedPhotoId) : [];

      $("noItems").style.display = linked.length ? "none" : "block";
      $("noItems").textContent = selectedPhotoId ? "No linked items for this photo yet." : "Select a photo to view its linked materials and items.";

      linked.forEach((it)=>{
        const div = document.createElement("div");
        div.className = "item";
        div.innerHTML = `
          <div class="name">${escapeHtml(it.title || "Item")}</div>
          <div class="meta">
            ${escapeHtml([it.category,it.brand,it.finish].filter(Boolean).join(" • "))}${(it.category||it.brand||it.finish) ? "<br/>" : ""}
            ${it.link ? `<a href="${escapeAttr(it.link)}" target="_blank" rel="noopener">${escapeHtml(it.link)}</a><br/>` : ""}
            ${it.price ? `Price: $${Number(it.price).toLocaleString(undefined,{maximumFractionDigits:2})}<br/>` : ""}
            ${it.notes ? escapeHtml(it.notes) : ""}
          </div>
        `;
        itemsWrap.appendChild(div);
      });
    }

    function setSection(section){
      filterSection = section;
      selectedPhotoId = null;
      $("chipInterior").classList.toggle("active", section === "interior");
      $("chipExterior").classList.toggle("active", section === "exterior");
      renderPhotos(loadHouse());
      renderItems(loadHouse());
    }

    $("chipInterior").addEventListener("click", ()=>setSection("interior"));
    $("chipExterior").addEventListener("click", ()=>setSection("exterior"));

    $("btnEditToggle").addEventListener("click", ()=>{
      modeEdit = !modeEdit;
      $("btnEditToggle").textContent = modeEdit ? "Edit: on" : "Edit: off";
      loadHouse();
    });

    $("addPhotoBtn").addEventListener("click", ()=>{
      const h = loadHouse();
      if(!h) return;

      const section = $("photoSection").value;
      const url = $("photoUrl").value.trim();
      const caption = $("photoCaption").value.trim();

      if(!url){
        alert("Paste an image URL first.");
        return;
      }

      HomagioDB.addPhoto(h.id, { section, url, caption });
      $("photoUrl").value = "";
      $("photoCaption").value = "";
      setSection(section);
    });

    $("addItemBtn").addEventListener("click", ()=>{
      const h = loadHouse();
      if(!h) return;

      const title = $("itTitle").value.trim();
      const category = $("itCategory").value.trim();
      const price = Number($("itPrice").value || 0);
      const brand = $("itBrand").value.trim();
      const finish = $("itFinish").value.trim();
      const link = $("itLink").value.trim();
      const notes = $("itNotes").value.trim();

      if(!title){
        alert("Add a title for the item.");
        return;
      }

      HomagioDB.addItem(h.id, {
        photoId: selectedPhotoId || null,
        title,
        category,
        price,
        brand,
        finish,
        link,
        notes
      });

      $("itTitle").value = "";
      $("itCategory").value = "";
      $("itPrice").value = "";
      $("itBrand").value = "";
      $("itFinish").value = "";
      $("itLink").value = "";
      $("itNotes").value = "";

      renderItems(loadHouse());
    });

    $("exportBtn").addEventListener("click", ()=>{
      alert("PDF export is a stub in the static site. Next step: wire html2pdf/jsPDF with a clean template.");
    });

    // Init
    HomagioDB.ensure();

    if(!houseId){
      $("houseTitle").textContent = "Missing house id";
      $("houseSub").textContent = "Open from My Houses.";
    } else {
      const h = loadHouse();
      if(h){
        renderBudget(h);
        renderPhotos(h);
        renderItems(h);
      }
    }
  </script>
</body>
</html>
