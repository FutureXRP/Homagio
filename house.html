<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
  <title>Homagio — House</title>
  <meta name="description" content="Track materials, links, and photos for your home." />
  <meta name="color-scheme" content="dark" />
  <meta name="theme-color" content="#07090d" />

  <style>
    :root{
      color-scheme: dark;

      --bg0:#07090d;
      --bg1:#0b0f16;
      --card0: rgba(255,255,255,.06);
      --card1: rgba(255,255,255,.09);
      --stroke: rgba(255,255,255,.10);
      --stroke2: rgba(255,255,255,.16);

      --text0: rgba(255,255,255,.92);
      --text1: rgba(255,255,255,.70);
      --text2: rgba(255,255,255,.55);

      --brand:#2d6cdf;
      --brand2:#1f4fb0;

      --radius:18px;
      --radius2:26px;

      --shadow: 0 18px 60px rgba(0,0,0,.55);
      --shadow2: 0 10px 30px rgba(0,0,0,.45);

      --max: 1180px;
    }

    *{ box-sizing:border-box; }
    html,body{ height:100%; }
    body{
      margin:0;
      font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial;
      background:
        radial-gradient(900px 500px at 20% -10%, rgba(45,108,223,.22), transparent 60%),
        radial-gradient(900px 500px at 80% -10%, rgba(120,70,255,.16), transparent 60%),
        linear-gradient(180deg, var(--bg0), var(--bg1));
      color: var(--text0);
    }
    a{ color:inherit; text-decoration:none; }
    .wrap{ max-width: var(--max); margin:0 auto; padding: 20px 18px 28px; }

    /* ---------- App Shell Header ---------- */
    .app-header{
      position: sticky;
      top: 0;
      z-index: 50;
      backdrop-filter: blur(10px);
      background: rgba(7,9,13,.72);
      border-bottom: 1px solid rgba(255,255,255,.08);
    }
    .app-header .wrap{ padding: 14px 18px; }
    .bar{ display:flex; align-items:center; gap:14px; justify-content:space-between; }
    .brand{ display:flex; align-items:center; gap:10px; min-width:170px; }
    .logo{
      width: 38px; height: 38px; border-radius: 14px;
      background:
        radial-gradient(circle at 30% 20%, rgba(255,255,255,0.25), transparent 40%),
        linear-gradient(180deg, rgba(45,108,223,0.98), rgba(31,79,176,0.98));
      box-shadow: 0 0 0 6px rgba(45,108,223,.22), 0 14px 34px rgba(0,0,0,.40);
      display:grid; place-items:center;
      border: 1px solid rgba(255,255,255,.12);
    }
    .brand h1{ font-size:14px; margin:0; letter-spacing:.3px; line-height:1.1; }
    .brand span{ display:block; font-size:12px; color:var(--text2); margin-top:2px; }

    .nav{ display:flex; gap:8px; align-items:center; flex-wrap:wrap; justify-content:center; }
    .nav a{
      padding: 10px 12px;
      border-radius: 12px;
      border: 1px solid transparent;
      color: var(--text1);
      font-size: 13px;
    }
    .nav a:hover{ background: rgba(255,255,255,.06); border-color: rgba(255,255,255,.08); color: var(--text0); }
    .nav a.active{ background: rgba(45,108,223,.14); border-color: rgba(45,108,223,.28); color: rgba(255,255,255,.92); }

    .right{ display:flex; align-items:center; gap:10px; min-width:170px; justify-content:flex-end; }
    .pill{
      display:inline-flex; align-items:center; gap:8px;
      padding: 10px 12px; border-radius:999px;
      border:1px solid rgba(255,255,255,.12);
      background: rgba(255,255,255,.06);
      color: var(--text1);
      font-size: 13px;
      box-shadow: var(--shadow2);
      white-space:nowrap;
    }
    .dot{ width:8px; height:8px; border-radius:99px; background: rgba(255,255,255,.35); box-shadow: 0 0 0 4px rgba(255,255,255,.08); }

    .btn{
      display:inline-flex; align-items:center; justify-content:center; gap:10px;
      padding: 12px 14px; border-radius:14px;
      border:1px solid rgba(255,255,255,.12);
      background: rgba(255,255,255,.06);
      color: rgba(255,255,255,.90);
      font-weight: 600; font-size:13px;
      cursor:pointer; user-select:none;
      box-shadow: var(--shadow2);
      white-space:nowrap;
    }
    .btn:hover{ background: rgba(255,255,255,.09); }
    .btn.primary{
      border-color: rgba(45,108,223,.35);
      background:
        radial-gradient(circle at 30% 20%, rgba(255,255,255,.16), transparent 46%),
        linear-gradient(180deg, rgba(45,108,223,.96), rgba(31,79,176,.96));
    }
    .btn.primary:hover{ filter: brightness(1.05); }

    @media (max-width: 960px){
      .right{ display:none; }
      .brand{ min-width:auto; }
    }

    /* ---------- Page ---------- */
    .page-head{
      display:flex;
      align-items:flex-end;
      justify-content:space-between;
      gap: 14px;
      padding: 18px 0 12px;
    }
    .page-head h2{ margin:0; font-size:22px; letter-spacing:.2px; }
    .page-head p{ margin:6px 0 0; color: var(--text2); font-size:13px; }

    .grid{
      display:grid;
      grid-template-columns: 1.05fr .95fr;
      gap: 16px;
      align-items:start;
    }
    @media (max-width: 980px){
      .grid{ grid-template-columns: 1fr; }
    }

    .card{
      border-radius: var(--radius2);
      background: linear-gradient(180deg, rgba(255,255,255,.07), rgba(255,255,255,.05));
      border: 1px solid rgba(255,255,255,.10);
      box-shadow: var(--shadow);
      overflow:hidden;
    }
    .card .hd{
      padding: 14px 14px 10px;
      border-bottom: 1px solid rgba(255,255,255,.08);
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap: 10px;
    }
    .card .hd h3{ margin:0; font-size:14px; letter-spacing:.25px; }
    .card .bd{ padding: 14px; }

    label{
      display:block;
      font-size: 12px;
      color: var(--text2);
      margin-bottom: 6px;
    }
    input, select, textarea{
      width: 100%;
      padding: 12px 12px;
      border-radius: 14px;
      border: 1px solid rgba(255,255,255,.12);
      background: rgba(0,0,0,.22);
      color: var(--text0);
      outline:none;
    }
    input:focus, select:focus, textarea:focus{
      border-color: rgba(45,108,223,.55);
      box-shadow: 0 0 0 4px rgba(45,108,223,.18);
    }

    .form{
      display:grid;
      grid-template-columns: 1fr 1fr;
      gap: 12px;
    }
    .full{ grid-column: 1 / -1; }

    .actions{ display:flex; gap:10px; align-items:center; justify-content:flex-end; flex-wrap:wrap; margin-top: 12px; }

    .list{ display:flex; flex-direction:column; gap: 10px; }
    .item{
      padding: 12px;
      border-radius: 18px;
      border: 1px solid rgba(255,255,255,.10);
      background: rgba(255,255,255,.05);
    }
    .item:hover{ background: rgba(255,255,255,.07); }
    .item .t{ display:flex; align-items:center; justify-content:space-between; gap:10px; }
    .item h4{ margin:0; font-size:14px; letter-spacing:.2px; }
    .meta{ margin-top:4px; color:var(--text2); font-size:12px; line-height:1.35; }
    .chiprow{ display:flex; gap:8px; flex-wrap:wrap; margin-top: 8px; }
    .chip{
      font-size: 12px;
      color: var(--text1);
      padding: 6px 10px;
      border-radius: 999px;
      border: 1px solid rgba(255,255,255,.10);
      background: rgba(255,255,255,.06);
    }

    .thumbs{
      display:grid;
      grid-template-columns: repeat(3, 1fr);
      gap: 10px;
    }
    @media (max-width: 980px){
      .thumbs{ grid-template-columns: repeat(2, 1fr); }
    }
    .thumb{
      border-radius: 18px;
      overflow:hidden;
      border: 1px solid rgba(255,255,255,.10);
      background: rgba(0,0,0,.20);
      min-height: 110px;
      display:flex;
      flex-direction:column;
    }
    .thumb img{
      width:100%;
      height: 120px;
      object-fit: cover;
      display:block;
    }
    .thumb .cap{
      padding: 10px;
      font-size: 12px;
      color: var(--text1);
      display:flex;
      justify-content:space-between;
      align-items:center;
      gap: 8px;
    }

    .muted{ color: var(--text2); font-size: 13px; }
    .danger{ border-color: rgba(255,80,80,.28) !important; background: rgba(255,80,80,.10) !important; }
  </style>
</head>

<body>
  <!-- App Shell Header -->
  <header class="app-header">
    <div class="wrap">
      <div class="bar">
        <a class="brand" href="index.html" aria-label="Homagio Home">
          <div class="logo" aria-hidden="true">
            <svg width="20" height="20" viewBox="0 0 24 24" fill="none">
              <path d="M12 3l9 7v10a2 2 0 0 1-2 2h-5v-7H10v7H5a2 2 0 0 1-2-2V10l9-7z" stroke="rgba(255,255,255,.92)" stroke-width="1.8" stroke-linejoin="round"/>
            </svg>
          </div>
          <div>
            <h1>Homagio</h1>
            <span id="brandSub">House</span>
          </div>
        </a>

        <nav class="nav" aria-label="Primary">
          <a href="explore.html">Explore</a>
          <a href="my.html">My Houses</a>
          <a class="active" href="#" id="houseNav">House</a>
        </nav>

        <div class="right">
          <div class="pill" title="Auth coming next">
            <span class="dot"></span>
            Guest Mode
          </div>
          <a class="btn" href="my.html">Back to list</a>
        </div>
      </div>
    </div>
  </header>

  <main class="wrap">
    <div class="page-head">
      <div>
        <h2 id="title">House</h2>
        <p id="subtitle">Track photos, materials, and purchase links.</p>
      </div>
      <div class="actions" style="margin:0;">
        <button class="btn" id="exportBtn" type="button">Export PDF (stub)</button>
        <a class="btn primary" id="openExplore" href="explore.html">Open Explore</a>
      </div>
    </div>

    <section class="grid">
      <!-- Left: Materials / Links -->
      <div class="card">
        <div class="hd">
          <h3>Materials & links</h3>
          <div class="muted" id="itemsCount">0</div>
        </div>
        <div class="bd">
          <form id="itemForm">
            <div class="form">
              <div class="full">
                <label>Item name</label>
                <input id="itemName" placeholder="e.g., Kitchen faucet — matte black" required />
              </div>
              <div>
                <label>Category</label>
                <input id="itemCat" placeholder="Faucet, Tile, Paint…" />
              </div>
              <div>
                <label>Price (optional)</label>
                <input id="itemPrice" type="number" min="0" step="0.01" placeholder="199.99" />
              </div>
              <div class="full">
                <label>Purchase link (optional)</label>
                <input id="itemLink" placeholder="https://…" />
              </div>
              <div class="full">
                <label>Notes (optional)</label>
                <textarea id="itemNotes" rows="2" placeholder="Finish, SKU, where used…"></textarea>
              </div>
            </div>
            <div class="actions">
              <button class="btn primary" type="submit">Add item</button>
            </div>
          </form>

          <div style="height:12px;"></div>
          <div class="list" id="itemsList"></div>
          <div class="muted" id="itemsEmpty" style="display:none;">
            No items yet — add your first material above.
          </div>
        </div>
      </div>

      <!-- Right: Photos -->
      <div class="card">
        <div class="hd">
          <h3>Photos</h3>
          <div class="muted" id="photosCount">0</div>
        </div>
        <div class="bd">
          <form id="photoForm">
            <div class="form">
              <div class="full">
                <label>Photo URL (temporary MVP)</label>
                <input id="photoUrl" placeholder="Paste an image URL…" required />
              </div>
              <div class="full">
                <label>Caption (optional)</label>
                <input id="photoCap" placeholder="e.g., Living room — new floors" />
              </div>
            </div>
            <div class="actions">
              <button class="btn primary" type="submit">Add photo</button>
            </div>
            <div class="muted" style="margin-top:10px;">
              Next backend step: Storage upload instead of URL paste.
            </div>
          </form>

          <div style="height:12px;"></div>
          <div class="thumbs" id="photosGrid"></div>
          <div class="muted" id="photosEmpty" style="display:none;">
            No photos yet — add one above.
          </div>
        </div>
      </div>
    </section>
  </main>

  <script src="assets/db.js"></script>
  <script>
    // House page controller. Works with MVP DB functions if available.
    const params = new URLSearchParams(location.search);
    const homeId = params.get('id');

    const titleEl = document.getElementById('title');
    const brandSub = document.getElementById('brandSub');
    const subtitleEl = document.getElementById('subtitle');

    const itemsCount = document.getElementById('itemsCount');
    const itemsList = document.getElementById('itemsList');
    const itemsEmpty = document.getElementById('itemsEmpty');

    const photosCount = document.getElementById('photosCount');
    const photosGrid = document.getElementById('photosGrid');
    const photosEmpty = document.getElementById('photosEmpty');

    function escapeHtml(s){
      return String(s ?? '')
        .replaceAll('&','&amp;')
        .replaceAll('<','&lt;')
        .replaceAll('>','&gt;')
        .replaceAll('"','&quot;')
        .replaceAll("'",'&#039;');
    }

    function getHome(){
      try{
        if(HomagioDB.getHomeById) return HomagioDB.getHomeById(homeId);
        if(HomagioDB.getHomes){
          const homes = HomagioDB.getHomes() || [];
          return homes.find(h => h.id === homeId);
        }
      }catch(e){}
      return null;
    }

    function getItems(){
      try{
        if(HomagioDB.getItemsForHome) return HomagioDB.getItemsForHome(homeId) || [];
        // fallback: DB might store items on home
        const h = getHome();
        return (h && h.items) ? h.items : [];
      }catch(e){}
      return [];
    }

    function getPhotos(){
      try{
        if(HomagioDB.getPhotosForHome) return HomagioDB.getPhotosForHome(homeId) || [];
        const h = getHome();
        return (h && h.photos) ? h.photos : [];
      }catch(e){}
      return [];
    }

    function render(){
      const h = getHome();
      if(!homeId || !h){
        titleEl.textContent = 'House not found';
        brandSub.textContent = 'House';
        subtitleEl.textContent = 'Go to My Houses and open a home.';
        document.querySelector('main').innerHTML = `
          <div class="wrap">
            <div class="card">
              <div class="hd"><h3>Missing house</h3><div class="muted">No ID or not found</div></div>
              <div class="bd">
                <div class="muted">Open <a class="btn primary" style="margin-left:10px;" href="my.html">My Houses</a> to create or select a home.</div>
              </div>
            </div>
          </div>
        `;
        return;
      }

      titleEl.textContent = h.name || 'House';
      brandSub.textContent = h.name || 'House';
      subtitleEl.textContent = h.address || '—';

      // Items
      const items = getItems();
      itemsCount.textContent = String(items.length);
      itemsList.innerHTML = '';
      if(!items.length){
        itemsEmpty.style.display = 'block';
      }else{
        itemsEmpty.style.display = 'none';
        for(const it of items){
          const name = escapeHtml(it.name || it.title || 'Item');
          const cat = escapeHtml(it.category || '');
          const notes = escapeHtml(it.notes || '');
          const price = (it.price != null && it.price !== '') ? `$${Number(it.price).toLocaleString(undefined,{maximumFractionDigits:2})}` : '';
          const link = it.link ? String(it.link) : '';

          const el = document.createElement('div');
          el.className = 'item';
          el.innerHTML = `
            <div class="t">
              <h4>${name}</h4>
              <span class="muted">${price || ''}</span>
            </div>
            <div class="meta">
              ${cat ? `<div>${cat}</div>` : ''}
              ${notes ? `<div>${notes}</div>` : ''}
              ${link ? `<div style="margin-top:6px;"><a class="chip" href="${escapeHtml(link)}" target="_blank" rel="noopener">Open link ↗</a></div>` : ''}
            </div>
          `;
          itemsList.appendChild(el);
        }
      }

      // Photos
      const photos = getPhotos();
      photosCount.textContent = String(photos.length);
      photosGrid.innerHTML = '';
      if(!photos.length){
        photosEmpty.style.display = 'block';
      }else{
        photosEmpty.style.display = 'none';
        for(const p of photos){
          const url = String(p.url || p.src || '');
          const cap = escapeHtml(p.caption || p.cap || '');
          const el = document.createElement('div');
          el.className = 'thumb';
          el.innerHTML = `
            <img src="${escapeHtml(url)}" alt="${cap || 'Photo'}" loading="lazy" />
            <div class="cap">
              <span>${cap || 'Photo'}</span>
              <span class="muted">✓</span>
            </div>
          `;
          photosGrid.appendChild(el);
        }
      }
    }

    // Add item
    document.getElementById('itemForm').addEventListener('submit', (e) => {
      e.preventDefault();
      if(!homeId) return;

      const item = {
        name: document.getElementById('itemName').value.trim(),
        category: document.getElementById('itemCat').value.trim(),
        price: document.getElementById('itemPrice').value.trim(),
        link: document.getElementById('itemLink').value.trim(),
        notes: document.getElementById('itemNotes').value.trim(),
        createdAt: Date.now()
      };

      try{
        if(HomagioDB.addItemToHome){
          HomagioDB.addItemToHome(homeId, item);
        }else if(HomagioDB.addItem){
          HomagioDB.addItem(homeId, item);
        }else{
          // fallback: attach to home and write if DB exposes update
          const h = getHome();
          h.items = h.items || [];
          h.items.push(item);
          if(HomagioDB.updateHome) HomagioDB.updateHome(homeId, h);
        }
      }catch(err){
        console.error(err);
        alert('Could not add item. Check console.');
      }

      e.target.reset();
      render();
    });

    // Add photo
    document.getElementById('photoForm').addEventListener('submit', (e) => {
      e.preventDefault();
      if(!homeId) return;

      const photo = {
        url: document.getElementById('photoUrl').value.trim(),
        caption: document.getElementById('photoCap').value.trim(),
        createdAt: Date.now()
      };

      try{
        if(HomagioDB.addPhotoToHome){
          HomagioDB.addPhotoToHome(homeId, photo);
        }else if(HomagioDB.addPhoto){
          HomagioDB.addPhoto(homeId, photo);
        }else{
          const h = getHome();
          h.photos = h.photos || [];
          h.photos.push(photo);
          if(HomagioDB.updateHome) HomagioDB.updateHome(homeId, h);
        }
      }catch(err){
        console.error(err);
        alert('Could not add photo. Check console.');
      }

      e.target.reset();
      render();
    });

    // Export (stub)
    document.getElementById('exportBtn').addEventListener('click', () => {
      alert('PDF export is stubbed right now. Next step: client-side export (jsPDF/html2pdf) or server-side (Firebase Function).');
    });

    render();
  </script>
</body>
</html>
