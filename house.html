<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>Homagio ‚Äî House</title>

<meta name="color-scheme" content="dark" />
<meta name="theme-color" content="#07090d" />

<!-- ‚úÖ FIX: correct DB file path -->
<script src="assets.db.js"></script>

<style>
:root{
  color-scheme: dark;
  --bg0:#07090d; --bg1:#0b0f16; --bg2:#0e1320;
  --text:#e9eef7; --muted:#b7c0d6; --muted2:#8a94ab;
  --shadow: 0 12px 40px rgba(0,0,0,.55);
}
*{box-sizing:border-box}
html,body{margin:0;height:100%}
body{
  font-family: system-ui,-apple-system,Segoe UI,Roboto;
  color:var(--text);
  background:
    radial-gradient(1200px 700px at 20% 10%, rgba(45,108,223,.18), transparent 60%),
    linear-gradient(180deg,var(--bg0),var(--bg1),var(--bg2));
}
a{text-decoration:none;color:inherit}

.header{
  position:sticky;top:0;z-index:10;
  backdrop-filter: blur(12px);
  background:rgba(10,12,18,.75);
  border-bottom:1px solid rgba(255,255,255,.08);
}
.header-inner{
  max-width:1000px;margin:auto;
  padding:12px 14px;
  display:flex;align-items:center;gap:12px;
}
.back{
  padding:8px 12px;border-radius:12px;
  border:1px solid rgba(255,255,255,.12);
  background:rgba(255,255,255,.06);
  font-weight:800;
}
.badges{display:flex;gap:8px;margin-top:6px;flex-wrap:wrap}
.badge{
  display:inline-flex;align-items:center;gap:6px;
  padding:4px 8px;border-radius:999px;
  border:1px solid rgba(255,255,255,.12);
  background:rgba(255,255,255,.06);
  font-size:12px;color:var(--muted);
  width:max-content;
}

.wrap{max-width:1000px;margin:auto;padding:14px}

.card{
  border-radius:18px;
  border:1px solid rgba(255,255,255,.1);
  background:rgba(255,255,255,.05);
  box-shadow:var(--shadow);
  padding:14px;
  margin-bottom:14px;
}

.title{font-size:22px;font-weight:900}
.sub{color:var(--muted2);font-size:13px;margin-top:4px}

.tabs{display:flex;gap:8px;margin-top:12px}
.tab{
  flex:1;text-align:center;padding:10px;
  border-radius:12px;
  border:1px solid rgba(255,255,255,.1);
  background:rgba(255,255,255,.05);
  font-weight:800;cursor:pointer;
  user-select:none;
}
.tab.active{background:linear-gradient(180deg,rgba(45,108,223,.9),rgba(31,79,176,.9))}

.grid{display:grid;grid-template-columns:repeat(3,1fr);gap:10px}
@media (max-width:420px){ .grid{grid-template-columns:repeat(2,1fr)} }

.photo{
  aspect-ratio:1/1;border-radius:14px;
  background:rgba(255,255,255,.08);
  position:relative;
  overflow:hidden;
  border:1px solid rgba(255,255,255,.08);
  cursor:pointer;
}
.photo img{width:100%;height:100%;object-fit:cover;display:block;filter:saturate(1.05)}
.photo .ph-inner{
  height:100%;
  display:grid;place-items:center;
  color:var(--muted2);
  font-weight:900;
}
.photo .ph-tag{
  position:absolute;left:8px;bottom:8px;
  font-size:11px;
  padding:4px 8px;border-radius:999px;
  border:1px solid rgba(255,255,255,.14);
  background:rgba(0,0,0,.35);
  color:var(--muted);
  backdrop-filter: blur(8px);
  max-width:calc(100% - 16px);
  overflow:hidden;text-overflow:ellipsis;white-space:nowrap;
}
.photo.selected{
  border-color: rgba(45,108,223,.8);
  box-shadow: 0 0 0 3px rgba(45,108,223,.22), var(--shadow);
}
.photo .ph-count{
  position:absolute;right:8px;top:8px;
  font-size:11px;
  padding:4px 8px;border-radius:999px;
  border:1px solid rgba(255,255,255,.14);
  background:rgba(0,0,0,.35);
  color:var(--muted);
  backdrop-filter: blur(8px);
}

.row{display:flex;justify-content:space-between;gap:12px;padding:8px 0;border-bottom:1px solid rgba(255,255,255,.08)}
.row:last-child{border-bottom:none}
.row span:first-child{color:var(--muted)}
.row strong{font-weight:900}

.btn{
  width:100%;
  padding:12px;border-radius:14px;
  border:1px solid rgba(255,255,255,.12);
  background:rgba(255,255,255,.06);
  font-weight:900;text-align:center;
  cursor:pointer;
  user-select:none;
}
.btn.primary{background:linear-gradient(180deg,rgba(45,108,223,.95),rgba(31,79,176,.95))}
.btn.small{
  width:auto;
  padding:8px 10px;
  border-radius:12px;
  font-size:12px;
  font-weight:900;
}
.actions{display:grid;gap:10px}

.details-head{display:flex;align-items:flex-start;justify-content:space-between;gap:10px}
.details-title{font-size:18px;font-weight:900}
.details-sub{color:var(--muted2);font-size:12px;margin-top:4px}
.details-tools{display:flex;gap:8px;flex-wrap:wrap;justify-content:flex-end}
hr.sep{border:none;border-top:1px solid rgba(255,255,255,.08);margin:12px 0}

.item{
  border:1px solid rgba(255,255,255,.1);
  background:rgba(255,255,255,.04);
  border-radius:14px;
  padding:12px;
  margin-bottom:10px;
}
.item:last-child{margin-bottom:0}
.item-name{font-weight:950;font-size:14px}
.item-meta{margin-top:6px;display:grid;gap:6px;font-size:13px;color:var(--muted)}
.kv{display:flex;justify-content:space-between;gap:14px}
.kv .k{color:var(--muted2)}
.kv .v{color:var(--text);font-weight:700;text-align:right}

.link{
  display:inline-flex;align-items:center;gap:8px;
  margin-top:10px;
  padding:10px 12px;
  border-radius:12px;
  border:1px solid rgba(255,255,255,.12);
  background:rgba(255,255,255,.06);
  font-weight:900;
}
.notice{
  border:1px dashed rgba(255,255,255,.18);
  background:rgba(255,255,255,.03);
  border-radius:14px;
  padding:12px;
  color:var(--muted);
  font-size:13px;
}
.details-card{scroll-margin-top:86px}

/* Simple modal */
.modalOverlay{
  position:fixed; inset:0; z-index:999;
  background: rgba(0,0,0,.55);
  display:none;
  align-items:flex-end;
}
.modal{
  width:100%;
  max-width:1000px;
  margin:0 auto;
  border-radius:22px 22px 0 0;
  border:1px solid rgba(255,255,255,.12);
  background: rgba(10,12,18,.92);
  padding:14px;
  box-shadow: var(--shadow);
}
.modalHead{display:flex;justify-content:space-between;align-items:center;gap:10px}
.modalHead b{font-size:16px}
.closeX{padding:8px 10px;border-radius:12px;border:1px solid rgba(255,255,255,.12);background:rgba(255,255,255,.06);cursor:pointer;font-weight:900}
.form{display:grid;gap:10px;margin-top:12px}
.field label{display:block;font-size:12px;color:var(--muted2);margin-bottom:6px;font-weight:800}
.field input,.field select{
  width:100%;
  padding:12px;
  border-radius:14px;
  border:1px solid rgba(255,255,255,.12);
  background:rgba(255,255,255,.06);
  color:var(--text);
  font-weight:800;
}
.grid2{display:grid;grid-template-columns:1fr 1fr;gap:10px}
@media (max-width:520px){ .grid2{grid-template-columns:1fr} }
</style>
</head>

<body>
<div class="header">
  <div class="header-inner">
    <a class="back" href="explore.html">‚Üê Back</a>
    <div>
      <div class="title" id="houseName">House</div>
      <div class="sub" id="houseStyle"></div>
      <div class="badges">
        <div class="badge" id="modeBadge">Mode: View</div>
        <div class="badge" id="tabBadge">Interior</div>
      </div>
    </div>
  </div>
</div>

<div class="wrap">
  <div class="card">
    <div class="tabs">
      <div class="tab active" data-tab="interior" onclick="switchTab(event,'interior')">Interior</div>
      <div class="tab" data-tab="exterior" onclick="switchTab(event,'exterior')">Exterior</div>
    </div>
    <div class="grid" id="photos"></div>
  </div>

  <div class="card details-card" id="detailsCard">
    <div class="details-head">
      <div>
        <div class="details-title" id="detailsTitle">Linked items</div>
        <div class="details-sub" id="detailsSub">Tap a photo above to see materials & purchase links.</div>
      </div>
      <div class="details-tools" id="detailsTools" style="display:none">
        <div class="btn small" onclick="openLinkModal()">+ Link item</div>
        <div class="btn small" onclick="openPhotoEditModal()">Edit photo</div>
      </div>
    </div>
    <hr class="sep"/>
    <div id="detailsBody">
      <div class="notice">Select a photo to view its linked materials and items.</div>
    </div>
  </div>

  <div class="card" id="budgetCard">
    <div class="title">Budget</div>
    <div class="row"><span>Total</span><strong id="budgetTotal">$0</strong></div>
    <div class="row"><span>Spent</span><strong id="budgetSpent">$0</strong></div>
    <div class="row"><span>Remaining</span><strong id="budgetRemain">$0</strong></div>
  </div>

  <div class="card actions" id="actionsCard">
    <div class="btn" onclick="openAddPhotoModal()">Add Photo</div>
    <div class="btn" onclick="openAddItemModal()">Add Item / Material</div>
    <div class="btn primary" onclick="exportPDF()">Export PDF</div>
  </div>
</div>

<!-- Modals -->
<div class="modalOverlay" id="modalOverlay" onclick="if(event.target===this) closeModal()">
  <div class="modal" id="modalBody"></div>
</div>

<script>
const params = new URLSearchParams(window.location.search);
const mode = (params.get("mode") || "view").toLowerCase() === "edit" ? "edit" : "view";
const houseId = params.get("id") || "demo-0";

let house = null;
let activeTab = "interior";
let selectedPhotoId = null;

const $houseName = document.getElementById("houseName");
const $houseStyle = document.getElementById("houseStyle");
const $modeBadge = document.getElementById("modeBadge");
const $tabBadge = document.getElementById("tabBadge");
const $photos = document.getElementById("photos");
const $detailsTitle = document.getElementById("detailsTitle");
const $detailsSub = document.getElementById("detailsSub");
const $detailsBody = document.getElementById("detailsBody");
const $detailsTools = document.getElementById("detailsTools");
const $actionsCard = document.getElementById("actionsCard");
const $budgetTotal = document.getElementById("budgetTotal");
const $budgetSpent = document.getElementById("budgetSpent");
const $budgetRemain = document.getElementById("budgetRemain");

const $overlay = document.getElementById("modalOverlay");
const $modal = document.getElementById("modalBody");

init();

function init(){
  // Ensure demo exists if someone deep-links to demo-0
  HomagioDB.seedDemoNear(36.15398, -95.99277, false);

  house = HomagioDB.getHouse(houseId);
  if(!house){
    // fallback
    house = HomagioDB.getHouse("demo-0");
  }

  $houseName.textContent = house?.name || "House";
  $houseStyle.textContent = house?.style || "";
  $modeBadge.textContent = `Mode: ${mode === "edit" ? "Owner" : "View"}`;

  // Budget
  const total = house?.budget?.total ?? 0;
  const spent = house?.budget?.spent ?? 0;
  const remain = Math.max(0, total - spent);
  $budgetTotal.textContent = formatMoney(total);
  $budgetSpent.textContent = formatMoney(spent);
  $budgetRemain.textContent = formatMoney(remain);

  if (mode === "edit") {
    $actionsCard.style.display = "grid";
    $detailsTools.style.display = "flex";
  } else {
    $actionsCard.style.display = "none";
    $detailsTools.style.display = "none";
  }

  renderPhotos();
  renderDetails(null);
}

function refreshHouse(){
  house = HomagioDB.getHouse(houseId) || house;
}

function formatMoney(n){
  try{
    return new Intl.NumberFormat("en-US",{style:"currency",currency:"USD",maximumFractionDigits:0}).format(Number(n||0));
  }catch(e){
    return "$" + (n||0);
  }
}

function switchTab(e, tab){
  activeTab = tab;
  $tabBadge.textContent = tab === "interior" ? "Interior" : "Exterior";

  document.querySelectorAll(".tab").forEach(t=>t.classList.remove("active"));
  const target = e?.target || document.querySelector(\`.tab[data-tab="\${tab}"]\`);
  if (target) target.classList.add("active");

  selectedPhotoId = null;
  renderPhotos();
  renderDetails(null);
}

function renderPhotos(){
  refreshHouse();
  const list = (house.photos || []).filter(p => p.tab === activeTab);

  if (!list.length) {
    $photos.innerHTML = `
      <div class="notice" style="grid-column:1/-1">
        No ${activeTab} photos yet.
        ${mode === "edit" ? " Tap ‚ÄúAdd Photo‚Äù to upload one." : ""}
      </div>`;
    return;
  }

  $photos.innerHTML = list.map(p => {
    const count = (p.linkedItemIds || []).length;
    const selected = p.id === selectedPhotoId ? "selected" : "";
    const label = escapeHtml(p.label || "Photo");
    const img = p.src ? `<img src="${escapeAttr(p.src)}" alt="${label}">` : `<div class="ph-inner">Photo</div>`;
    return `
      <div class="photo ${selected}" role="button" tabindex="0"
           onclick="selectPhoto('${p.id}')"
           onkeydown="if(event.key==='Enter'||event.key===' '){event.preventDefault();selectPhoto('${p.id}')}"
           aria-label="Open details for ${label}">
        ${img}
        <div class="ph-tag">${label}</div>
        <div class="ph-count">${count} item${count===1?"":"s"}</div>
      </div>`;
  }).join("");
}

function selectPhoto(photoId){
  selectedPhotoId = photoId;
  document.querySelectorAll(".photo").forEach(el => el.classList.remove("selected"));
  // re-render to apply selected class cleanly
  renderPhotos();

  refreshHouse();
  const photo = (house.photos || []).find(p => p.id === photoId);
  renderDetails(photo);

  document.getElementById("detailsCard").scrollIntoView({behavior:"smooth", block:"start"});
}

function renderDetails(photo){
  if (!photo) {
    $detailsTitle.textContent = "Linked items";
    $detailsSub.textContent = "Tap a photo above to see materials & purchase links.";
    $detailsBody.innerHTML = `<div class="notice">Select a photo to view its linked materials and items.</div>`;
    return;
  }

  const label = photo.label || "Selected photo";
  const ids = photo.linkedItemIds || [];
  const items = ids.map(itemId => house.items?.[itemId]).filter(Boolean);

  $detailsTitle.textContent = label;
  $detailsSub.textContent = `${activeTab === "interior" ? "Interior" : "Exterior"} ‚Ä¢ ${ids.length} linked item${ids.length===1?"":"s"}`;

  if (!ids.length) {
    $detailsBody.innerHTML = `
      <div class="notice">
        No items linked to this photo yet.
        ${mode === "edit" ? " Tap ‚Äú+ Link item‚Äù to connect a material or FF&E item." : ""}
      </div>`;
    return;
  }

  const missingCount = ids.length - items.length;

  $detailsBody.innerHTML = `
    ${items.map(it => renderItemCard(it, photo.id)).join("")}
    ${missingCount > 0 ? `<div class="notice">Note: ${missingCount} linked item(s) could not be found.</div>` : ``}
  `;
}

function renderItemCard(it, photoId){
  const purchase = it.purchaseUrl ? `
    <a class="link" href="${escapeAttr(it.purchaseUrl)}" target="_blank" rel="noopener noreferrer">
      üîó View purchase link
    </a>` : `<div class="notice" style="margin-top:10px">No purchase link saved.</div>`;

  const editTools = mode === "edit" ? `
    <div class="details-tools" style="margin-top:10px;justify-content:flex-start">
      <div class="btn small" onclick="openEditItemModal('${it.id}')">Edit</div>
      <div class="btn small" onclick="unlinkItem('${photoId}','${it.id}')">Unlink</div>
    </div>` : ``;

  return `
    <div class="item">
      <div class="item-name">${escapeHtml(it.name || "Item")}</div>
      <div class="item-meta">
        <div class="kv"><div class="k">Category</div><div class="v">${escapeHtml(it.category || "‚Äî")}</div></div>
        <div class="kv"><div class="k">Color/Pattern</div><div class="v">${escapeHtml(it.colorPattern || "‚Äî")}</div></div>
        <div class="kv"><div class="k">Brand</div><div class="v">${escapeHtml(it.brand || "‚Äî")}</div></div>
        <div class="kv"><div class="k">Style/Finish</div><div class="v">${escapeHtml(it.styleFinish || "‚Äî")}</div></div>
      </div>
      ${purchase}
      ${editTools}
    </div>
  `;
}

function unlinkItem(photoId, itemId){
  if(!selectedPhotoId) return;
  if (!confirm("Unlink this item from the selected photo?")) return;
  HomagioDB.unlinkItem(houseId, photoId, itemId);
  refreshHouse();
  const photo = (house.photos || []).find(p => p.id === photoId);
  renderPhotos();
  renderDetails(photo);
}

// ---------- Modals ----------
function openModal(html){
  $modal.innerHTML = html;
  $overlay.style.display = "flex";
}
function closeModal(){
  $overlay.style.display = "none";
  $modal.innerHTML = "";
}

function openAddPhotoModal(){
  openModal(`
    <div class="modalHead">
      <b>Add Photo</b>
      <div class="closeX" onclick="closeModal()">‚úï</div>
    </div>
    <div class="form">
      <div class="grid2">
        <div class="field">
          <label>Interior/Exterior</label>
          <select id="phTab">
            <option value="interior">Interior</option>
            <option value="exterior">Exterior</option>
          </select>
        </div>
        <div class="field">
          <label>Label (e.g., Kitchen, Front Elevation)</label>
          <input id="phLabel" placeholder="Kitchen" />
        </div>
      </div>
      <div class="field">
        <label>Image</label>
        <input id="phFile" type="file" accept="image/*" />
      </div>
      <div class="btn primary" onclick="savePhoto()">Save Photo</div>
    </div>
  `);
}

async function savePhoto(){
  const tab = document.getElementById("phTab").value;
  const label = document.getElementById("phLabel").value.trim() || (tab === "interior" ? "Interior" : "Exterior");
  const file = document.getElementById("phFile").files?.[0];
  if(!file){
    alert("Please choose an image.");
    return;
  }
  const src = await fileToDataURL(file);
  HomagioDB.addPhoto(houseId, { tab, label, src });
  closeModal();
  activeTab = tab;
  document.querySelectorAll(".tab").forEach(t=>t.classList.remove("active"));
  document.querySelector(\`.tab[data-tab="\${tab}"]\`)?.classList.add("active");
  $tabBadge.textContent = tab === "interior" ? "Interior" : "Exterior";
  renderPhotos();
}

function openAddItemModal(){
  openModal(`
    <div class="modalHead">
      <b>Add Item / Material</b>
      <div class="closeX" onclick="closeModal()">‚úï</div>
    </div>
    <div class="form">
      <div class="field"><label>Name</label><input id="itName" placeholder="Pendant Light" /></div>
      <div class="grid2">
        <div class="field"><label>Category</label><input id="itCat" placeholder="Interior ‚Ä¢ Lighting" /></div>
        <div class="field"><label>Color/Pattern</label><input id="itColor" placeholder="Black + Brass" /></div>
      </div>
      <div class="grid2">
        <div class="field"><label>Brand</label><input id="itBrand" placeholder="West Elm" /></div>
        <div class="field"><label>Style/Finish</label><input id="itStyle" placeholder="Modern Dome" /></div>
      </div>
      <div class="field"><label>Purchase link</label><input id="itUrl" placeholder="https://..." /></div>
      <div class="btn primary" onclick="saveItem()">Save Item</div>
    </div>
  `);
}

function saveItem(){
  const it = {
    name: document.getElementById("itName").value.trim(),
    category: document.getElementById("itCat").value.trim(),
    colorPattern: document.getElementById("itColor").value.trim(),
    brand: document.getElementById("itBrand").value.trim(),
    styleFinish: document.getElementById("itStyle").value.trim(),
    purchaseUrl: document.getElementById("itUrl").value.trim()
  };
  if(!it.name){
    alert("Name is required.");
    return;
  }
  const saved = HomagioDB.addItem(houseId, it);
  closeModal();

  // Nice UX: if a photo is selected, immediately offer to link
  if(selectedPhotoId){
    HomagioDB.linkItem(houseId, selectedPhotoId, saved.id);
    refreshHouse();
    const photo = (house.photos || []).find(p => p.id === selectedPhotoId);
    renderPhotos();
    renderDetails(photo);
  }
}

function openLinkModal(){
  if(!selectedPhotoId){
    alert("Select a photo first.");
    return;
  }
  refreshHouse();
  const items = Object.values(house.items || {});
  if(!items.length){
    alert("No items exist yet. Add an item first.");
    return;
  }

  const options = items.map(it => `
    <div class="row" style="margin:0;border-radius:14px" onclick="linkThis('${it.id}')">
      <div class="meta">
        <div class="badge" aria-hidden="true">üîó</div>
        <div style="min-width:0">
          <b>${escapeHtml(it.name)}</b>
          <small>${escapeHtml(it.category || "Item")}</small>
        </div>
      </div>
      <div class="right"><div class="mi">Link</div></div>
    </div>
  `).join("");

  openModal(`
    <div class="modalHead">
      <b>Link an item</b>
      <div class="closeX" onclick="closeModal()">‚úï</div>
    </div>
    <div class="form">
      <div class="notice">Tap an item to link it to the selected photo.</div>
      <div style="display:grid;gap:10px">${options}</div>
    </div>
  `);
}

function linkThis(itemId){
  HomagioDB.linkItem(houseId, selectedPhotoId, itemId);
  closeModal();
  refreshHouse();
  const photo = (house.photos || []).find(p => p.id === selectedPhotoId);
  renderPhotos();
  renderDetails(photo);
}

function openEditItemModal(itemId){
  refreshHouse();
  const it = house.items?.[itemId];
  if(!it) return;

  openModal(`
    <div class="modalHead">
      <b>Edit Item</b>
      <div class="closeX" onclick="closeModal()">‚úï</div>
    </div>
    <div class="form">
      <div class="field"><label>Name</label><input id="eitName" value="${escapeAttr(it.name || "")}" /></div>
      <div class="grid2">
        <div class="field"><label>Category</label><input id="eitCat" value="${escapeAttr(it.category || "")}" /></div>
        <div class="field"><label>Color/Pattern</label><input id="eitColor" value="${escapeAttr(it.colorPattern || "")}" /></div>
      </div>
      <div class="grid2">
        <div class="field"><label>Brand</label><input id="eitBrand" value="${escapeAttr(it.brand || "")}" /></div>
        <div class="field"><label>Style/Finish</label><input id="eitStyle" value="${escapeAttr(it.styleFinish || "")}" /></div>
      </div>
      <div class="field"><label>Purchase link</label><input id="eitUrl" value="${escapeAttr(it.purchaseUrl || "")}" /></div>
      <div class="btn primary" onclick="saveEditItem('${itemId}')">Save Changes</div>
    </div>
  `);
}

function saveEditItem(itemId){
  HomagioDB.updateItem(houseId, itemId, {
    name: document.getElementById("eitName").value.trim(),
    category: document.getElementById("eitCat").value.trim(),
    colorPattern: document.getElementById("eitColor").value.trim(),
    brand: document.getElementById("eitBrand").value.trim(),
    styleFinish: document.getElementById("eitStyle").value.trim(),
    purchaseUrl: document.getElementById("eitUrl").value.trim(),
  });
  closeModal();
  refreshHouse();
  const photo = selectedPhotoId ? (house.photos || []).find(p => p.id === selectedPhotoId) : null;
  renderPhotos();
  renderDetails(photo);
}

function openPhotoEditModal(){
  if(!selectedPhotoId){
    alert("Select a photo first.");
    return;
  }
  refreshHouse();
  const p = (house.photos || []).find(x => x.id === selectedPhotoId);
  if(!p) return;

  openModal(`
    <div class="modalHead">
      <b>Edit Photo</b>
      <div class="closeX" onclick="closeModal()">‚úï</div>
    </div>
    <div class="form">
      <div class="grid2">
        <div class="field">
          <label>Interior/Exterior</label>
          <select id="ephTab">
            <option value="interior" ${p.tab==="interior"?"selected":""}>Interior</option>
            <option value="exterior" ${p.tab==="exterior"?"selected":""}>Exterior</option>
          </select>
        </div>
        <div class="field">
          <label>Label</label>
          <input id="ephLabel" value="${escapeAttr(p.label || "")}" />
        </div>
      </div>
      <div class="btn primary" onclick="savePhotoEdit('${p.id}')">Save</div>
    </div>
  `);
}

function savePhotoEdit(photoId){
  const tab = document.getElementById("ephTab").value;
  const label = document.getElementById("ephLabel").value.trim() || "Photo";
  HomagioDB.updatePhoto(houseId, photoId, { tab, label });
  closeModal();

  // If it moved tabs, update view
  activeTab = tab;
  document.querySelectorAll(".tab").forEach(t=>t.classList.remove("active"));
  document.querySelector(\`.tab[data-tab="\${tab}"]\`)?.classList.add("active");
  $tabBadge.textContent = tab === "interior" ? "Interior" : "Exterior";

  renderPhotos();
  selectPhoto(photoId);
}

function exportPDF(){
  // MVP export: print. Later: jsPDF/html2canvas
  window.print();
}

function fileToDataURL(file){
  return new Promise((resolve, reject) => {
    const reader = new FileReader();
    reader.onload = () => resolve(String(reader.result || ""));
    reader.onerror = reject;
    reader.readAsDataURL(file);
  });
}

/* escaping helpers */
function escapeHtml(str){
  return String(str ?? "")
    .replaceAll("&","&amp;").replaceAll("<","&lt;")
    .replaceAll(">","&gt;").replaceAll('"',"&quot;")
    .replaceAll("'","&#039;");
}
function escapeAttr(str){
  return escapeHtml(str).replaceAll("`","&#096;");
}
</script>
</body>
</html>
