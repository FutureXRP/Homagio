<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover">
<title>House ‚Ä¢ Homagio</title>
<link rel="stylesheet" href="assets/styles.css">
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
<script src="assets.db.js"></script>
</head>
<body>
<header class="nav"> <!-- SAME PREMIUM NAV AS ABOVE --> </header>

<main class="wrap" style="padding:40px 0">
<button onclick="location.href='my.html'" class="btn btn-ghost" style="margin-bottom:20px">‚Üê Back to My Houses</button>
<h1 id="houseTitle" class="section-title"></h1>

<div style="display:flex;gap:10px;margin:20px 0;flex-wrap:wrap">
<button onclick="showTab(0)" class="btn btn-primary tab-btn" id="tab0">Photos</button>
<button onclick="showTab(1)" class="btn btn-ghost tab-btn" id="tab1">Materials</button>
<button onclick="showTab(2)" class="btn btn-ghost tab-btn" id="tab2">Budget</button>
</div>

<div id="content"></div>

<div style="margin-top:40px;display:flex;gap:12px">
<button onclick="exportPDF()" class="btn btn-primary">üìÑ Export PDF Report</button>
<button onclick="exportCSV()" class="btn btn-ghost">üìã Export Shopping CSV</button>
</div>
</main>

<script>
let currentHouse;
function loadHouse(){
  currentHouse = window.HomagioDB.getCurrentHouse();
  if(!currentHouse) return location.href='my.html';
  document.getElementById('houseTitle').textContent = currentHouse.name;
  showTab(0);
}

function showTab(n){
  document.querySelectorAll('.tab-btn').forEach(b=>b.className=b.className.replace('btn-primary','btn-ghost'));
  document.getElementById('tab'+n).className = document.getElementById('tab'+n).className.replace('btn-ghost','btn-primary');
  const div = document.getElementById('content');
  if(n===0){ // Photos
    div.innerHTML = `<input type="file" id="photoInput" accept="image/*" style="display:none" onchange="uploadPhoto(event)"><button onclick="document.getElementById('photoInput').click()" class="btn btn-primary">üì∏ Add Photo</button><div id="photoGrid" style="display:grid;grid-template-columns:repeat(auto-fill,minmax(220px,1fr));gap:14px;margin-top:20px"></div>`;
    renderPhotos();
  } else if(n===1){ // Materials
    div.innerHTML = `<p style="color:var(--muted)">Materials & linked items will appear here (coming in next update).</p>`;
  } else { // Budget
    div.innerHTML = `<p><strong>Total Budget:</strong> $${(currentHouse.budget?.total||0).toLocaleString()}<br><strong>Spent:</strong> $${(currentHouse.budget?.spent||0).toLocaleString()}</p>`;
  }
}

function renderPhotos(){
  const grid = document.getElementById('photoGrid');
  if(!grid) return;
  grid.innerHTML = '';
  (currentHouse.photos||[]).forEach(p => {
    const d = document.createElement('div');
    d.className = 'shot-tile';
    d.innerHTML = p.src ? `<img src="${p.src}" style="aspect-ratio:16/10">` : `<div class="placeholder">Photo</div>`;
    grid.appendChild(d);
  });
}

function uploadPhoto(e){
  const file = e.target.files[0];
  if(!file) return;
  const reader = new FileReader();
  reader.onload = ev => {
    if(!currentHouse.photos) currentHouse.photos = [];
    currentHouse.photos.push({id:window.HomagioDB.uid('ph'), tab:'interior', label:'New Photo', src:ev.target.result});
    window.HomagioDB.updateHouse(currentHouse.id, currentHouse);
    renderPhotos();
  };
  reader.readAsDataURL(file);
}

function exportPDF(){
  const {jsPDF} = window.jspdf;
  const doc = new jsPDF();
  doc.text(currentHouse.name,20,20);
  doc.text(`Budget: $${currentHouse.budget.spent} / $${currentHouse.budget.total}`,20,40);
  doc.save(currentHouse.name.replace(/ /g,'-')+'-report.pdf');
}

function exportCSV(){
  let csv = 'Item,Category,Brand,Link\n';
  Object.values(currentHouse.items||{}).forEach(it => {
    csv += `"${it.name}","${it.category}","${it.brand}","${it.purchaseUrl}"\n`;
  });
  const blob = new Blob([csv], {type:'text/csv'});
  const url = URL.createObjectURL(blob);
  const a = document.createElement('a');
  a.href = url; a.download = currentHouse.name+'-shopping.csv'; a.click();
}

loadHouse();
</script>
</body>
</html>
