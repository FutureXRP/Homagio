<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
  <title>Homagio — Explore</title>
  <meta name="description" content="Explore homes around you in Homagio." />
  <meta name="color-scheme" content="dark" />
  <meta name="theme-color" content="#07090d" />

  <!-- Leaflet -->
  <link
    rel="stylesheet"
    href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"
    integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY="
    crossorigin=""
  />
  <script
    src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"
    integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo="
    crossorigin=""
  ></script>

  <style>
    :root{
      color-scheme: dark;

      --bg0:#07090d;
      --bg1:#0b0f16;
      --card0: rgba(255,255,255,.06);
      --card1: rgba(255,255,255,.09);
      --stroke: rgba(255,255,255,.10);
      --stroke2: rgba(255,255,255,.16);

      --text0: rgba(255,255,255,.92);
      --text1: rgba(255,255,255,.70);
      --text2: rgba(255,255,255,.55);

      --brand:#2d6cdf;
      --brand2:#1f4fb0;

      --radius:18px;
      --radius2:26px;

      --shadow: 0 18px 60px rgba(0,0,0,.55);
      --shadow2: 0 10px 30px rgba(0,0,0,.45);

      --max: 1180px;
    }

    *{ box-sizing:border-box; }
    html,body{ height:100%; }
    body{
      margin:0;
      font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial;
      background:
        radial-gradient(900px 500px at 20% -10%, rgba(45,108,223,.22), transparent 60%),
        radial-gradient(900px 500px at 80% -10%, rgba(120,70,255,.16), transparent 60%),
        linear-gradient(180deg, var(--bg0), var(--bg1));
      color: var(--text0);
    }
    a{ color:inherit; text-decoration:none; }

    .wrap{ max-width: var(--max); margin:0 auto; padding: 20px 18px 28px; }

    /* ---------- App Shell Header ---------- */
    .app-header{
      position: sticky;
      top: 0;
      z-index: 50;
      backdrop-filter: blur(10px);
      background: rgba(7,9,13,.72);
      border-bottom: 1px solid rgba(255,255,255,.08);
    }
    .app-header .wrap{ padding: 14px 18px; }
    .bar{ display:flex; align-items:center; gap:14px; justify-content:space-between; }
    .brand{ display:flex; align-items:center; gap:10px; min-width:170px; }
    .logo{
      width: 38px; height: 38px; border-radius: 14px;
      background:
        radial-gradient(circle at 30% 20%, rgba(255,255,255,0.25), transparent 40%),
        linear-gradient(180deg, rgba(45,108,223,0.98), rgba(31,79,176,0.98));
      box-shadow: 0 0 0 6px rgba(45,108,223,.22), 0 14px 34px rgba(0,0,0,.40);
      display:grid; place-items:center;
      border: 1px solid rgba(255,255,255,.12);
    }
    .brand h1{ font-size:14px; margin:0; letter-spacing:.3px; line-height:1.1; }
    .brand span{ display:block; font-size:12px; color:var(--text2); margin-top:2px; }

    .nav{ display:flex; gap:8px; align-items:center; flex-wrap:wrap; justify-content:center; }
    .nav a{
      padding: 10px 12px;
      border-radius: 12px;
      border: 1px solid transparent;
      color: var(--text1);
      font-size: 13px;
    }
    .nav a:hover{ background: rgba(255,255,255,.06); border-color: rgba(255,255,255,.08); color: var(--text0); }
    .nav a.active{ background: rgba(45,108,223,.14); border-color: rgba(45,108,223,.28); color: rgba(255,255,255,.92); }

    .right{ display:flex; align-items:center; gap:10px; min-width:170px; justify-content:flex-end; }
    .pill{
      display:inline-flex; align-items:center; gap:8px;
      padding: 10px 12px; border-radius:999px;
      border:1px solid rgba(255,255,255,.12);
      background: rgba(255,255,255,.06);
      color: var(--text1);
      font-size: 13px;
      box-shadow: var(--shadow2);
      white-space:nowrap;
    }
    .dot{ width:8px; height:8px; border-radius:99px; background: rgba(255,255,255,.35); box-shadow: 0 0 0 4px rgba(255,255,255,.08); }

    .btn{
      display:inline-flex; align-items:center; justify-content:center; gap:10px;
      padding: 12px 14px; border-radius:14px;
      border:1px solid rgba(255,255,255,.12);
      background: rgba(255,255,255,.06);
      color: rgba(255,255,255,.90);
      font-weight: 600; font-size:13px;
      cursor:pointer; user-select:none;
      box-shadow: var(--shadow2);
      white-space:nowrap;
    }
    .btn:hover{ background: rgba(255,255,255,.09); }
    .btn.primary{
      border-color: rgba(45,108,223,.35);
      background:
        radial-gradient(circle at 30% 20%, rgba(255,255,255,.16), transparent 46%),
        linear-gradient(180deg, rgba(45,108,223,.96), rgba(31,79,176,.96));
    }
    .btn.primary:hover{ filter: brightness(1.05); }

    @media (max-width: 960px){
      .right{ display:none; }
      .brand{ min-width:auto; }
    }

    /* ---------- Explore Layout ---------- */
    .page-head{
      display:flex;
      align-items:flex-end;
      justify-content:space-between;
      gap: 14px;
      padding: 18px 0 12px;
    }
    .page-head h2{ margin:0; font-size:22px; letter-spacing:.2px; }
    .page-head p{ margin:6px 0 0; color: var(--text2); font-size:13px; }

    .shell{
      display:grid;
      grid-template-columns: 1.35fr .65fr;
      gap: 16px;
      align-items: stretch;
    }
    @media (max-width: 980px){
      .shell{ grid-template-columns: 1fr; }
    }

    .card{
      border-radius: var(--radius2);
      background: linear-gradient(180deg, rgba(255,255,255,.07), rgba(255,255,255,.05));
      border: 1px solid rgba(255,255,255,.10);
      box-shadow: var(--shadow);
      overflow:hidden;
    }
    .card .hd{
      padding: 14px 14px 10px;
      border-bottom: 1px solid rgba(255,255,255,.08);
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap: 10px;
    }
    .card .hd h3{ margin:0; font-size:14px; letter-spacing:.25px; }
    .card .bd{ padding: 14px; }

    .map-wrap{ height: 560px; }
    @media (max-width: 980px){ .map-wrap{ height: 440px; } }

    #map{
      width:100%;
      height:100%;
      border-radius: calc(var(--radius2) - 6px);
      overflow:hidden;
      border:1px solid rgba(255,255,255,.10);
      background: rgba(0,0,0,.25);
    }

    .controls{
      display:flex;
      gap:10px;
      align-items:center;
      flex-wrap: wrap;
    }
    .controls label{
      font-size: 12px;
      color: var(--text2);
      display:flex;
      align-items:center;
      gap: 8px;
    }
    .controls input{
      width: 90px;
      padding: 10px 10px;
      border-radius: 12px;
      border: 1px solid rgba(255,255,255,.12);
      background: rgba(0,0,0,.22);
      color: var(--text0);
      outline:none;
    }
    .controls input:focus{
      border-color: rgba(45,108,223,.55);
      box-shadow: 0 0 0 4px rgba(45,108,223,.18);
    }

    .panel{
      display:flex;
      flex-direction:column;
      gap: 12px;
    }

    .list{
      display:flex;
      flex-direction:column;
      gap: 10px;
    }
    .item{
      display:block;
      padding: 12px;
      border-radius: 18px;
      border: 1px solid rgba(255,255,255,.10);
      background: rgba(255,255,255,.05);
    }
    .item:hover{ background: rgba(255,255,255,.07); }
    .item .t{
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap: 10px;
    }
    .item h4{
      margin:0;
      font-size: 14px;
      letter-spacing:.2px;
    }
    .meta{
      margin-top: 4px;
      color: var(--text2);
      font-size: 12px;
      line-height: 1.35;
    }
    .chiprow{ display:flex; gap:8px; flex-wrap:wrap; margin-top: 8px; }
    .chip{
      font-size: 12px;
      color: var(--text1);
      padding: 6px 10px;
      border-radius: 999px;
      border: 1px solid rgba(255,255,255,.10);
      background: rgba(255,255,255,.06);
    }

    .muted{ color: var(--text2); font-size: 13px; }

    /* Marker icon */
    .house-pin {
      width: 38px;
      height: 38px;
      border-radius: 14px;
      border: 2px solid rgba(255, 255, 255, 0.35);
      background:
        radial-gradient(circle at 30% 20%, rgba(255, 255, 255, 0.25), transparent 40%),
        linear-gradient(180deg, rgba(45, 108, 223, 0.95), rgba(31, 79, 176, 0.95));
      display: grid;
      place-items: center;
      box-shadow:
        0 0 0 6px rgba(45, 108, 223, 0.25),
        0 14px 34px rgba(0, 0, 0, 0.35);
    }
    .house-pin svg { opacity: 0.95; }
  </style>
</head>

<body>
  <!-- App Shell Header -->
  <header class="app-header">
    <div class="wrap">
      <div class="bar">
        <a class="brand" href="index.html" aria-label="Homagio Home">
          <div class="logo" aria-hidden="true">
            <svg width="20" height="20" viewBox="0 0 24 24" fill="none">
              <path d="M12 3l9 7v10a2 2 0 0 1-2 2h-5v-7H10v7H5a2 2 0 0 1-2-2V10l9-7z" stroke="rgba(255,255,255,.92)" stroke-width="1.8" stroke-linejoin="round"/>
            </svg>
          </div>
          <div>
            <h1>Homagio</h1>
            <span>Explore homes</span>
          </div>
        </a>

        <nav class="nav" aria-label="Primary">
          <a class="active" href="explore.html">Explore</a>
          <a href="my.html">My Houses</a>
        </nav>

        <div class="right">
          <div class="pill" title="Auth coming next">
            <span class="dot"></span>
            Guest Mode
          </div>
          <a class="btn primary" href="my.html">Create House</a>
        </div>
      </div>
    </div>
  </header>

  <main class="wrap">
    <div class="page-head">
      <div>
        <h2>Explore</h2>
        <p>Find homes and jump into materials + links. (Map style is intentionally lighter so pins pop.)</p>
      </div>
      <div class="controls">
        <label>
          Radius (mi)
          <input id="radius" type="number" min="0.2" step="0.2" value="2.0" />
        </label>
        <button class="btn" id="locateBtn" type="button">Use my location</button>
        <button class="btn" id="seedBtn" type="button">Seed demo</button>
      </div>
    </div>

    <section class="shell">
      <!-- Map -->
      <div class="card">
        <div class="hd">
          <h3>Map</h3>
          <div class="muted" id="status">Ready</div>
        </div>
        <div class="bd map-wrap">
          <div id="map" role="application" aria-label="Homagio map"></div>
        </div>
      </div>

      <!-- Side Panel -->
      <aside class="panel">
        <div class="card">
          <div class="hd">
            <h3>Homes</h3>
            <div class="muted" id="count">0</div>
          </div>
          <div class="bd">
            <div class="list" id="homesList"></div>
            <div class="muted" id="empty" style="display:none;">
              No homes found in range. Try a bigger radius, seed demo, or create a house in “My Houses”.
            </div>
          </div>
        </div>

        <div class="card">
          <div class="hd">
            <h3>Links</h3>
            <div class="muted" id="linksHint">Select a home</div>
          </div>
          <div class="bd">
            <div class="list" id="linksList"></div>
            <div class="muted" id="linksEmpty" style="display:none;">
              No links for this home yet. Open it → add materials with purchase links.
            </div>
          </div>
        </div>
      </aside>
    </section>
  </main>

  <script src="assets/db.js"></script>
  <script>
    // ----- Map Defaults
    const DEFAULT = { lat: 36.1540, lng: -95.9928, zoom: 12 }; // Tulsa
    let map, markerLayer, radiusCircle;
    let center = { ...DEFAULT };
    let currentRadiusMi = 2.0;

    const statusEl = document.getElementById('status');
    const radiusEl = document.getElementById('radius');
    const listEl = document.getElementById('homesList');
    const emptyEl = document.getElementById('empty');
    const countEl = document.getElementById('count');

    const linksList = document.getElementById('linksList');
    const linksEmpty = document.getElementById('linksEmpty');
    const linksHint = document.getElementById('linksHint');

    function setStatus(t){ statusEl.textContent = t; }

    function pinIcon(){
      return L.divIcon({
        className: '',
        html: `
          <div class="house-pin" title="Home">
            <svg width="18" height="18" viewBox="0 0 24 24" fill="none">
              <path d="M12 3l9 7v10a2 2 0 0 1-2 2h-5v-7H10v7H5a2 2 0 0 1-2-2V10l9-7z"
                stroke="rgba(255,255,255,.92)" stroke-width="1.8" stroke-linejoin="round"/>
            </svg>
          </div>
        `,
        iconSize: [38,38],
        iconAnchor: [19,19]
      });
    }

    function safeInvalidate(){
      try{ map && map.invalidateSize(); }catch(e){}
    }

    function milesToMeters(mi){ return mi * 1609.344; }

    function getHomes(){
      return (HomagioDB.getHomes && HomagioDB.getHomes()) || [];
    }

    function distMiles(a, b){
      // haversine
      const R = 3958.8;
      const toRad = d => d * Math.PI / 180;
      const dLat = toRad(b.lat - a.lat);
      const dLng = toRad(b.lng - a.lng);
      const lat1 = toRad(a.lat);
      const lat2 = toRad(b.lat);
      const h = Math.sin(dLat/2)**2 + Math.cos(lat1)*Math.cos(lat2)*Math.sin(dLng/2)**2;
      return 2 * R * Math.asin(Math.sqrt(h));
    }

    function withinRadius(h){
      if(h.lat == null || h.lng == null) return false;
      return distMiles(center, {lat:h.lat, lng:h.lng}) <= currentRadiusMi;
    }

    function clearLinks(){
      linksList.innerHTML = '';
      linksEmpty.style.display = 'none';
      linksHint.textContent = 'Select a home';
    }

    function renderLinksForHome(homeId){
      linksList.innerHTML = '';
      linksEmpty.style.display = 'none';

      // Try to read items/materials if DB supports it; otherwise show empty
      let links = [];
      try{
        if(HomagioDB.getItemsForHome){
          const items = HomagioDB.getItemsForHome(homeId) || [];
          links = items
            .filter(i => i.link)
            .map(i => ({ title: i.name || i.title || 'Item', url: i.link }));
        }
      }catch(e){}

      if(!links.length){
        linksEmpty.style.display = 'block';
        linksHint.textContent = 'No links yet';
        return;
      }

      linksHint.textContent = `${links.length} links`;
      for(const l of links){
        const a = document.createElement('a');
        a.className = 'item';
        a.href = l.url;
        a.target = '_blank';
        a.rel = 'noopener';
        a.innerHTML = `
          <div class="t">
            <h4>${escapeHtml(l.title)}</h4>
            <span class="muted">Open ↗</span>
          </div>
          <div class="meta">${escapeHtml(l.url)}</div>
        `;
        linksList.appendChild(a);
      }
    }

    function escapeHtml(s){
      return String(s ?? '')
        .replaceAll('&','&amp;')
        .replaceAll('<','&lt;')
        .replaceAll('>','&gt;')
        .replaceAll('"','&quot;')
        .replaceAll("'",'&#039;');
    }

    function render(){
      const homes = getHomes().filter(withinRadius);
      countEl.textContent = String(homes.length);
      listEl.innerHTML = '';
      markerLayer.clearLayers();
      clearLinks();

      if(radiusCircle){
        radiusCircle.setLatLng([center.lat, center.lng]);
        radiusCircle.setRadius(milesToMeters(currentRadiusMi));
      }

      if(!homes.length){
        emptyEl.style.display = 'block';
        return;
      }
      emptyEl.style.display = 'none';

      for(const h of homes){
        const m = L.marker([h.lat, h.lng], { icon: pinIcon() }).addTo(markerLayer);
        m.on('click', () => {
          linksHint.textContent = 'Loading…';
          renderLinksForHome(h.id);
        });

        const el = document.createElement('a');
        el.className = 'item';
        el.href = `house.html?id=${encodeURIComponent(h.id)}`;
        el.innerHTML = `
          <div class="t">
            <h4>${escapeHtml(h.name || 'Untitled')}</h4>
            <span class="muted">Open →</span>
          </div>
          <div class="meta">${escapeHtml(h.address || '')}</div>
          <div class="chiprow">
            ${h.style ? `<span class="chip">${escapeHtml(h.style)}</span>` : ''}
            <span class="chip">${(distMiles(center, {lat:h.lat, lng:h.lng})).toFixed(1)} mi</span>
          </div>
        `;
        el.addEventListener('mouseenter', () => {
          // Preview links without navigating
          linksHint.textContent = 'Preview…';
          renderLinksForHome(h.id);
        });
        listEl.appendChild(el);
      }
    }

    function setRadius(mi){
      currentRadiusMi = Math.max(0.2, Number(mi || 2.0));
      render();
    }

    async function init(){
      setStatus('Loading map…');

      map = L.map('map', { zoomControl: true });

      // Lighter map so pins/labels are visible (no dark tiles)
      L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
        maxZoom: 19,
        attribution: '&copy; OpenStreetMap contributors'
      }).addTo(map);

      markerLayer = L.layerGroup().addTo(map);

      map.setView([DEFAULT.lat, DEFAULT.lng], DEFAULT.zoom);

      radiusCircle = L.circle([DEFAULT.lat, DEFAULT.lng], {
        radius: milesToMeters(currentRadiusMi),
        color: 'rgba(45,108,223,.85)',
        weight: 2,
        fillColor: 'rgba(45,108,223,.20)',
        fillOpacity: 0.35
      }).addTo(map);

      window.addEventListener('resize', safeInvalidate);
      setStatus('Ready');

      // Seed demo near default for instant content if DB supports it
      try{
        if(HomagioDB.seedDemoNear){
          HomagioDB.seedDemoNear(DEFAULT.lat, DEFAULT.lng, false);
        }
      }catch(e){}

      setRadius(Number(radiusEl.value));
      safeInvalidate();
    }

    document.getElementById('seedBtn').addEventListener('click', () => {
      try{
        if(HomagioDB.seedDemoNear){
          HomagioDB.seedDemoNear(center.lat, center.lng, true);
        }
      }catch(e){}
      render();
    });

    document.getElementById('locateBtn').addEventListener('click', () => {
      if(!navigator.geolocation){
        alert('Geolocation not supported in this browser.');
        return;
      }
      setStatus('Locating…');
      navigator.geolocation.getCurrentPosition((pos) => {
        center = { lat: pos.coords.latitude, lng: pos.coords.longitude, zoom: 13 };
        map.setView([center.lat, center.lng], center.zoom);
        setStatus('Using your location');
        render();
      }, (err) => {
        console.warn(err);
        setStatus('Location unavailable (using default)');
        alert('Could not get your location. Using default map center.');
      }, { enableHighAccuracy: true, timeout: 8000 });
    });

    radiusEl.addEventListener('change', () => setRadius(radiusEl.value));
    radiusEl.addEventListener('input', () => setRadius(radiusEl.value));

    init();
  </script>
</body>
</html>
