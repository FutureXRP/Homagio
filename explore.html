<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
<title>Homagio ‚Äî Explore</title>
<meta name="description" content="Explore Homagio homes around you in real time." />
<meta name="color-scheme" content="dark" />
<meta name="theme-color" content="#07090d" />

<!-- Leaflet -->
<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" crossorigin="" />
<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js" crossorigin=""></script>

<!-- Homagio local DB -->
<script src="assets.db.js"></script>

<style>
:root{
  color-scheme: dark;
  --bg0:#07090d; --bg1:#0b0f16; --bg2:#0e1320;
  --text:#e9eef7; --muted:#b7c0d6; --muted2:#8a94ab;
  --blue:#2d6cdf; --blue2:#1f4fb0; --green:#1fbf6a;
  --shadow: 0 12px 40px rgba(0,0,0,.55);
  --safe-bottom: env(safe-area-inset-bottom, 0px);
  --panelW: 420px;
}
*{box-sizing:border-box}
html,body,.stage{height:100%;margin:0}
body{
  font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial;
  background:
    radial-gradient(1200px 700px at 20% 10%, rgba(45,108,223,.18), transparent 60%),
    radial-gradient(900px 600px at 85% 30%, rgba(31,191,106,.12), transparent 55%),
    linear-gradient(180deg, var(--bg0), var(--bg1) 35%, var(--bg2));
  color:var(--text);
  overflow:hidden;
}
a{color:inherit;text-decoration:none}

.topbar{
  position:fixed; top:0; left:0; right:0; z-index:80;
  backdrop-filter: blur(14px);
  -webkit-backdrop-filter: blur(14px);
  background: rgba(8,10,15,.62);
  border-bottom: 1px solid rgba(255,255,255,.08);
}
.topbar .inner{
  height:56px;
  display:flex; align-items:center; justify-content:space-between;
  padding: 0 14px;
  gap:10px;
  max-width: 1120px;
  margin: 0 auto;
}
.brand{display:flex; align-items:center; gap:10px; min-width:170px;}
.logo{
  width:34px;height:34px;border-radius:12px;
  border:1px solid rgba(255,255,255,.12);
  background: linear-gradient(145deg, rgba(45,108,223,.7), rgba(31,191,106,.35));
  box-shadow: 0 10px 22px rgba(0,0,0,.35);
}
.brand b{display:block;font-size:14px;font-weight:900}
.brand span{display:block;font-size:12px;color:var(--muted2);margin-top:2px}

.btn{
  display:inline-flex; align-items:center; justify-content:center; gap:10px;
  padding:10px 12px; border-radius:14px;
  font-weight:800; font-size:13px;
  border:1px solid rgba(255,255,255,.10);
  background: rgba(255,255,255,.06);
  cursor:pointer;
  color:var(--text);
  transition:.12s ease;
  user-select:none;
  white-space:nowrap;
}
.btn:hover{background: rgba(255,255,255,.08)}
.btn:active{transform:scale(.98)}
.btn.primary{
  background: linear-gradient(180deg, rgba(45,108,223,.95), rgba(31,79,176,.95));
  border-color: rgba(255,255,255,.12);
}
.pill{
  display:inline-flex; align-items:center; gap:8px;
  padding:9px 10px;border-radius:999px;
  border:1px solid rgba(255,255,255,.10);
  background: rgba(255,255,255,.05);
  color: var(--muted);
  font-size: 12px;
  font-weight: 800;
  user-select:none;
}
.dot{
  width:8px;height:8px;border-radius:99px;background: rgba(255,255,255,.22);
  box-shadow:0 0 0 6px rgba(255,255,255,.08);
}
.dot.on{background: var(--green); box-shadow:0 0 0 6px rgba(31,191,106,.12);}

.stage{
  position:fixed;
  inset:56px 0 0 0;
  display:block;
}

/* Map */
#map{
  position:absolute;
  top:0; left:0; right:0; bottom:0;
  height:100%;
  width:auto;
  z-index: 1;
  background:#0a0c12;
}

.side{
  position:absolute;
  top:0; right:0; bottom:0;
  width: var(--panelW);
  z-index: 70;
  padding: 12px 12px 12px 0;
  display:none;
  pointer-events:none;
}
.side-inner{
  pointer-events:auto;
  height:100%;
  border-radius: 26px;
  border:1px solid rgba(255,255,255,.12);
  background: rgba(10,12,18,.72);
  backdrop-filter: blur(18px);
  -webkit-backdrop-filter: blur(18px);
  box-shadow: var(--shadow);
  overflow:hidden;
  display:flex;
  flex-direction:column;
}
.panel-head{padding: 14px 14px 12px;border-bottom: 1px solid rgba(255,255,255,.06);}
.panel-title{font-weight:900}
.panel-sub{font-size:12px;color:var(--muted2); margin-top:4px}
.controls{display:flex;gap:8px;flex-wrap:wrap;margin-top: 10px;}
.range{display:inline-flex; align-items:center; gap:10px;padding: 8px 10px; border-radius: 14px;border:1px solid rgba(255,255,255,.10);background: rgba(255,255,255,.05);font-size: 12px; color: var(--muted);font-weight: 800;}
.range input{width:120px}
.list{flex: 1 1 auto;overflow:auto;-webkit-overflow-scrolling: touch;padding: 10px 10px 12px;}
.row{display:flex; align-items:center; justify-content:space-between; gap:12px;padding: 12px 12px;border-radius: 18px;border:1px solid rgba(255,255,255,.08);background: rgba(255,255,255,.05);margin: 8px 0;cursor:pointer;}
.row:hover{background: rgba(255,255,255,.07)}
.row:active{transform: scale(.99)}
.row .meta{display:flex; gap:10px; align-items:flex-start; min-width:0;}
.badge{width:34px;height:34px;border-radius:14px;border:1px solid rgba(255,255,255,.12);background: rgba(45,108,223,.14);display:grid; place-items:center;flex: 0 0 auto;}
.row b{display:block; font-size:14px; white-space:nowrap; overflow:hidden; text-overflow:ellipsis; max-width: 240px;}
.row small{display:block; font-size:12px; color:var(--muted2); margin-top:2px; white-space:nowrap; overflow:hidden; text-overflow:ellipsis; max-width: 260px;}
.right{text-align:right; flex:0 0 auto;}
.right .mi{font-weight:900; font-size:13px}
.right .tag{font-size:11px; color:var(--muted2); margin-top:2px}

.house-pin{
  width: 40px;height: 40px;border-radius: 16px;
  border: 2px solid rgba(0,0,0,.22);
  background:
    radial-gradient(circle at 30% 20%, rgba(255,255,255,.35), transparent 40%),
    linear-gradient(180deg, rgba(45,108,223,1), rgba(31,79,176,1));
  display:grid;place-items:center;
  box-shadow:0 0 0 6px rgba(45,108,223,.22),0 14px 34px rgba(0,0,0,.40);
}
.me-dot{
  width:14px;height:14px;border-radius:99px;background: var(--blue);
  box-shadow: 0 0 0 8px rgba(45,108,223,.18), 0 10px 22px rgba(0,0,0,.28);
  border: 2px solid rgba(255,255,255,.92);
}

.leaflet-control-zoom a{
  background: rgba(10,12,18,.80) !important;
  color: var(--text) !important;
  border: 1px solid rgba(255,255,255,.10) !important;
  backdrop-filter: blur(12px);
}
.leaflet-control-attribution{
  background: rgba(255,255,255,.92) !important;
  color: rgba(0,0,0,.72) !important;
  border-radius: 12px !important;
  border: 1px solid rgba(0,0,0,.10) !important;
}

.sheet{position:fixed;left:0; right:0; bottom:0;z-index:75;padding: 10px 12px calc(12px + var(--safe-bottom));pointer-events:none;}
.sheet-inner{pointer-events:auto;max-width: 1120px;margin: 0 auto;border-radius: 26px;border:1px solid rgba(255,255,255,.12);background: rgba(10,12,18,.72);backdrop-filter: blur(18px);-webkit-backdrop-filter: blur(18px);box-shadow: var(--shadow);overflow:hidden;}
.grab{display:flex; justify-content:center; padding:10px 0 4px;}
.grab span{width:46px;height:5px;border-radius:999px;background:rgba(255,255,255,.18);}
.sheet-head{padding: 8px 14px 12px;display:flex; align-items:center; justify-content:space-between; gap:10px;border-top: 1px solid rgba(255,255,255,.06);border-bottom: 1px solid rgba(255,255,255,.06);}

@media (min-width: 980px){
  .side{display:block;}
  .sheet{display:none;}
  #map{right: var(--panelW);}
}
</style>
</head>

<body>
<header class="topbar">
  <div class="inner">
    <a class="brand" href="index.html">
      <div class="logo" aria-hidden="true"></div>
      <div>
        <b>Homagio</b>
        <span>Explore nearby homes</span>
      </div>
    </a>
    <div style="display:flex; gap:8px; align-items:center;">
      <div class="pill" title="Location status">
        <span class="dot" id="gpsDot"></span>
        <strong id="gpsText">GPS off</strong>
      </div>
      <button class="btn" id="recenterBtn">Recenter</button>
      <button class="btn" id="demoBtn">Demo</button>
      <button class="btn primary" id="startBtn">Start</button>
    </div>
  </div>
</header>

<div class="stage">
  <div id="map"></div>

  <aside class="side" aria-label="Homes panel">
    <div class="side-inner">
      <div class="panel-head">
        <div class="panel-title">Homes near you</div>
        <div class="panel-sub" id="sublineSide">Tap Demo to load sample homes.</div>
        <div class="controls">
          <div class="range" title="Search radius">
            Radius:
            <input id="radiusSide" type="range" min="0.5" max="10" step="0.5" value="2.0" />
            <span id="radiusLabelSide">2.0 mi</span>
          </div>
        </div>
      </div>
      <div class="list" id="listSide"></div>
    </div>
  </aside>
</div>

<div class="sheet">
  <div class="sheet-inner">
    <div class="grab"><span></span></div>
    <div class="sheet-head">
      <div>
        <div class="panel-title">Homes near you</div>
        <div class="panel-sub" id="sublineMobile">Tap Demo to load sample homes.</div>
      </div>
      <div class="controls">
        <div class="range">
          Radius:
          <input id="radiusMobile" type="range" min="0.5" max="10" step="0.5" value="2.0" />
          <span id="radiusLabelMobile">2.0 mi</span>
        </div>
      </div>
    </div>
    <div class="list" id="listMobile"></div>
  </div>
</div>

<script>
console.log('%cüöÄ Homagio Explore FULL SCRIPT LOADED', 'color:#1fbf6a;font-size:16px;font-weight:900');

const DEFAULT = { lat: 36.15398, lng: -95.99277, zoom: 13 };
const startBtn = document.getElementById('startBtn');
const recenterBtn = document.getElementById('recenterBtn');
const demoBtn = document.getElementById('demoBtn');
const gpsDot = document.getElementById('gpsDot');
const gpsText = document.getElementById('gpsText');
const listSide = document.getElementById('listSide');
const sublineSide = document.getElementById('sublineSide');
const radiusSide = document.getElementById('radiusSide');
const radiusLabelSide = document.getElementById('radiusLabelSide');
const listMobile = document.getElementById('listMobile');
const sublineMobile = document.getElementById('sublineMobile');
const radiusMobile = document.getElementById('radiusMobile');
const radiusLabelMobile = document.getElementById('radiusLabelMobile');

let map = null;
let watchId = null;
let me = null;
let meMarker = null;
let houseMarkers = [];
let radiusMiles = 2.0;

function setGpsStatus(on, text){
  gpsText.textContent = text;
  gpsDot.classList.toggle('on', !!on);
}

function toRad(x){ return x * Math.PI / 180; }
function haversineMiles(aLat,aLng,bLat,bLng){
  const R = 3958.7613;
  const dLat = toRad(bLat-aLat);
  const dLng = toRad(bLng-aLng);
  const s1 = Math.sin(dLat/2)**2;
  const s2 = Math.cos(toRad(aLat))*Math.cos(toRad(bLat))*Math.sin(dLng/2)**2;
  return 2*R*Math.asin(Math.sqrt(s1+s2));
}

const houseIcon = L.divIcon({
  className: '',
  html: `<div class="house-pin"><svg width="16" height="16" viewBox="0 0 24 24" fill="none"><path d="M4 11.2 12 5l8 6.2V20a1.6 1.6 0 0 1-1.6 1.6H5.6A1.6 1.6 0 0 1 4 20v-8.8Z" stroke="rgba(255,255,255,.96)" stroke-width="2" stroke-linejoin="round"/><path d="M9.5 21v-6.5h5V21" stroke="rgba(31,191,106,.98)" stroke-width="2" stroke-linecap="round"/></svg></div>`,
  iconSize: [40, 40],
  iconAnchor: [20, 20]
});

const meIcon = L.divIcon({
  className: '',
  html: `<div class="me-dot"></div>`,
  iconSize: [14,14],
  iconAnchor: [7,7]
});

function safeInvalidate(){
  if (!map) return;
  map.invalidateSize(true);
  setTimeout(() => map && map.invalidateSize(true), 120);
  setTimeout(() => map && map.invalidateSize(true), 450);
}

/* ---- Robust data helpers ---- */
function asNum(x){
  const n = typeof x === "number" ? x : parseFloat(String(x ?? ""));
  return Number.isFinite(n) ? n : null;
}
function hasPin(h){
  const lat = asNum(h?.lat);
  const lng = asNum(h?.lng);
  return lat != null && lng != null && Math.abs(lat) <= 90 && Math.abs(lng) <= 180;
}
function houseAddress(h){
  return (h?.address?.formatted || h?.address?.raw || "").trim();
}

function initMap(){
  if (typeof L === "undefined") {
    document.getElementById('map').innerHTML = `<div style="height:100%;display:grid;place-items:center;color:#f66">Leaflet failed to load</div>`;
    return;
  }
  if (typeof HomagioDB === "undefined") {
    document.getElementById('map').innerHTML = `<div style="height:100%;display:grid;place-items:center;color:#f66">HomagioDB failed to load (assets.db.js)</div>`;
    return;
  }

  map = L.map('map', { zoomControl: true });

  L.tileLayer('https://{s}.basemaps.cartocdn.com/dark_all/{z}/{x}/{y}.png', {
    maxZoom: 19,
    attribution: '&copy; OpenStreetMap &copy; CartoDB'
  }).addTo(map);

  map.setView([DEFAULT.lat, DEFAULT.lng], DEFAULT.zoom);
  window.addEventListener('resize', safeInvalidate);

  // Seed demo near default so Demo houses exist
  HomagioDB.seedDemoNear(DEFAULT.lat, DEFAULT.lng, false);

  // Do NOT render before map exists
  setRadius(2.0, { skipRender: true });
  renderHouses();

  safeInvalidate();
}

function setMeMarker(){
  if(!me || !map) return;
  if(!meMarker) meMarker = L.marker([me.lat, me.lng], {icon: meIcon}).addTo(map);
  else meMarker.setLatLng([me.lat, me.lng]);
}

function clearHouseMarkers(){
  if(!map) { houseMarkers = []; return; }
  houseMarkers.forEach(m => { try { map.removeLayer(m); } catch(e) {} });
  houseMarkers = [];
}

function focusHouse(h){
  if(!map) return;

  if(!hasPin(h)){
    const addr = houseAddress(h);
    alert(addr ? "This house has an address but no map pin yet.\n\nOpen it in Edit mode and save a geocoded address to generate a pin." : "This house has no map location yet.");
    return;
  }

  const lat = asNum(h.lat);
  const lng = asNum(h.lng);

  map.setView([lat, lng], 16, {animate:true});

  const viewUrl = `house.html?id=${encodeURIComponent(h.id)}&mode=view`;
  const editUrl = `house.html?id=${encodeURIComponent(h.id)}&mode=edit`;

  L.popup().setLatLng([lat, lng]).setContent(`
    <div style="font-family:system-ui;min-width:200px">
      <div style="font-weight:900">${escapeHtml(h.name)}</div>
      <div style="color:#8a94ab;font-size:12px">${escapeHtml(h.style||'')} ‚Ä¢ ${escapeHtml(h.tier||'')}</div>
      <div style="color:#8a94ab;font-size:12px;margin-top:4px">${escapeHtml(houseAddress(h) || '')}</div>
      <button onclick="window.location='${viewUrl}'" style="width:100%;margin:8px 0;padding:10px;background:#2d6cdf;color:white;border:none;border-radius:12px;cursor:pointer">View House</button>
      <button onclick="window.location='${editUrl}'" style="width:100%;padding:10px;background:rgba(255,255,255,.1);color:white;border:none;border-radius:12px;cursor:pointer">Edit (Owner)</button>
    </div>
  `).openOn(map);
}

function escapeHtml(s){
  return String(s??'').replace(/[&<>"']/g, m => ({
    '&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#039;'
  })[m]);
}

function setSubline(text){
  sublineSide.textContent = text;
  sublineMobile.textContent = text;
}

function renderInto(container, visible){
  container.innerHTML = '';
  if(!visible.length){
    container.innerHTML = `<div style="padding:14px;color:var(--muted);font-size:13px">No homes in radius. Tap Demo or increase radius.</div>`;
    return;
  }

  visible.forEach(h => {
    const milesTxt = h.miles == null ? '‚Äî' : `${h.miles.toFixed(2)} mi`;
    const addr = houseAddress(h);
    const pinOk = hasPin(h);

    const row = document.createElement('div');
    row.className = 'row';
    row.innerHTML = `
      <div class="meta">
        <div class="badge">${pinOk ? 'üè†' : '‚ö†Ô∏è'}</div>
        <div>
          <b>${escapeHtml(h.name)}</b>
          <small>
            ${escapeHtml(h.style||'')}
            ‚Ä¢ ${pinOk ? 'Tap for details' : (addr ? 'Needs map pin (address saved)' : 'Needs address/pin')}
          </small>
        </div>
      </div>
      <div class="right">
        <div class="mi">${milesTxt}</div>
        <div class="tag">${escapeHtml(h.tier||'')}</div>
      </div>
    `;
    row.addEventListener('click', () => focusHouse(h));
    container.appendChild(row);
  });
}

function renderHouses(){
  if(!map) return;

  clearHouseMarkers();

  const all = HomagioDB.getAllHouses() || [];
  if(!all.length){
    setSubline('Tap Demo to load sample homes.');
    renderInto(listSide, []);
    renderInto(listMobile, []);
    return;
  }

  // Split into pinned vs unpinned (unpinned still shows in list)
  const pinned = [];
  const unpinned = [];

  all.forEach(h => (hasPin(h) ? pinned : unpinned).push(h));

  // Compute visible based on radius (only pinned can be distance-filtered)
  let visiblePinned = pinned.slice();

  if(me){
    visiblePinned = visiblePinned
      .map(h => {
        const lat = asNum(h.lat), lng = asNum(h.lng);
        return {...h, miles: haversineMiles(me.lat, me.lng, lat, lng)};
      })
      .filter(h => h.miles <= radiusMiles)
      .sort((a,b) => a.miles - b.miles);

    setSubline(`Showing homes within ${radiusMiles.toFixed(1)} miles`);
  } else {
    visiblePinned = visiblePinned.map(h => ({...h, miles: null}));
    setSubline('Demo mode ‚Äî enable GPS for real-time');
  }

  // Add markers for pinned only
  visiblePinned.forEach(h => {
    const lat = asNum(h.lat);
    const lng = asNum(h.lng);
    try{
      const m = L.marker([lat, lng], {icon: houseIcon})
        .addTo(map)
        .on('click', () => focusHouse(h));
      houseMarkers.push(m);
    }catch(e){
      console.warn("Marker failed for house", h?.id, e);
    }
  });

  // List shows pinned first (visible), then unpinned
  const visibleList = [...visiblePinned, ...unpinned.map(h => ({...h, miles: null}))];

  renderInto(listSide, visibleList);
  renderInto(listMobile, visibleList);

  safeInvalidate();
}

function recenter(){
  if(me && map) map.setView([me.lat, me.lng], 15, {animate:true});
}

function startGps(){
  if(!navigator.geolocation) return alert('Geolocation not supported');
  setGpsStatus(false, 'Starting...');
  watchId = navigator.geolocation.watchPosition(
    pos => {
      me = {lat: pos.coords.latitude, lng: pos.coords.longitude};
      setGpsStatus(true, 'GPS on');
      setMeMarker();
      HomagioDB.seedDemoNear(me.lat, me.lng, false);
      renderHouses();
      recenter();
    },
    err => {
      console.error(err);
      setGpsStatus(false, 'GPS blocked');
    },
    {enableHighAccuracy:true}
  );
}

// options.skipRender used during initMap
function setRadius(v, options = {}){
  radiusMiles = v;
  radiusSide.value = radiusMobile.value = String(v);
  radiusLabelSide.textContent = radiusLabelMobile.textContent = `${v.toFixed(1)} mi`;
  if (!options.skipRender) renderHouses();
}

radiusSide.addEventListener('input', () => setRadius(parseFloat(radiusSide.value)));
radiusMobile.addEventListener('input', () => setRadius(parseFloat(radiusMobile.value)));
startBtn.addEventListener('click', startGps);
recenterBtn.addEventListener('click', recenter);

demoBtn.addEventListener('click', () => {
  const lat = me?.lat ?? DEFAULT.lat;
  const lng = me?.lng ?? DEFAULT.lng;

  // keep your existing demo reset function
  HomagioDB.resetDemo(lat, lng);

  setGpsStatus(!!me, me ? 'GPS on' : 'Demo');
  if(me) setMeMarker();

  renderHouses();

  if(!me && map) map.setView([DEFAULT.lat, DEFAULT.lng], DEFAULT.zoom);
  safeInvalidate();
});

// START
window.addEventListener('load', initMap);
</script>
</body>
</html>
