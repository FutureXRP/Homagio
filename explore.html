<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
  <title>Homagio — Explore</title>
  <meta name="description" content="Explore nearby homes around you in real time." />
  <meta name="color-scheme" content="light dark" />

  <!-- ✅ IMPORTANT: RELATIVE PATHS for GitHub Pages (/Homagio/) -->
  <link rel="stylesheet" href="./assets/styles.css" />

  <!-- Leaflet -->
  <link
    rel="stylesheet"
    href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"
    integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY="
    crossorigin=""
  />
  <script
    src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"
    integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo="
    crossorigin=""
    defer
  ></script>

  <!-- Shared JS -->
  <script defer src="./assets/core.js"></script>
  <script defer src="./assets/db.js"></script>

  <style>
    /* Explore-specific polish */
    .topbar-actions{
      display:flex;
      gap:10px;
      align-items:center;
      flex-wrap:wrap;
      justify-content:flex-end;
    }
    .pill{
      display:inline-flex;
      align-items:center;
      gap:8px;
      padding:8px 10px;
      border-radius:999px;
      border:1px solid rgba(15,23,42,.14);
      background: rgba(255,255,255,.92);
      font-weight:800;
      font-size:12px;
      color: var(--muted);
      user-select:none;
    }
    .pill b{color: var(--text)}
    .dot{
      width:10px;height:10px;border-radius:999px;
      background: rgba(100,116,139,.45);
      box-shadow: 0 0 0 5px rgba(100,116,139,.12);
    }
    .dot.on{
      background: linear-gradient(180deg, var(--blue), var(--blue2));
      box-shadow: 0 0 0 5px rgba(37,99,235,.14);
    }
    .range{
      display:flex;
      gap:10px;
      align-items:center;
      width:100%;
    }
    .range input[type="range"]{width: 220px; max-width: 60vw}
    .range .val{
      min-width: 64px;
      text-align:right;
      font-weight:900;
      color: var(--text);
    }
    .empty{
      padding: 14px;
      border-radius: 14px;
      border: 1px dashed rgba(15,23,42,.18);
      background: rgba(2,6,23,.02);
      color: var(--muted);
      line-height:1.5;
    }

    /* Zillow-ish marker label */
    .price-pin{
      display:inline-flex;
      align-items:center;
      justify-content:center;
      gap:8px;
      padding: 8px 10px;
      border-radius: 999px;
      border: 1px solid rgba(15,23,42,.18);
      background: rgba(255,255,255,.96);
      box-shadow: 0 12px 26px rgba(2,6,23,.14);
      font-weight: 900;
      color: var(--text);
      transform: translateY(-8px);
      white-space:nowrap;
    }
    .price-pin .mini{
      width:10px;height:10px;border-radius:999px;
      background: linear-gradient(180deg, var(--blue), var(--blue2));
      box-shadow: 0 0 0 5px rgba(37,99,235,.12);
    }
    .price-pin.sel{
      border-color: rgba(37,99,235,.28);
      box-shadow: 0 14px 30px rgba(37,99,235,.18);
    }

    /* Guarantee map height */
    #map{ height: 560px; }
    @media (max-width: 980px){ #map{ height: 420px; } }
  </style>
</head>

<body>
  <!-- Top Nav -->
  <div class="nav">
    <div class="wrap nav-inner">
      <a class="brand" href="./index.html">
        <span class="logo-dot"></span>
        <span>Homagio</span>
      </a>

      <div class="nav-links">
        <a class="link" href="./index.html">Home</a>
        <a class="link" href="./my.html">My Houses</a>
        <a class="link active" href="./explore.html">Explore</a>
      </div>

      <div class="topbar-actions">
        <div class="pill" id="gpsPill">
          <span class="dot" id="gpsDot"></span>
          <span>GPS:</span> <b id="gpsTxt">off</b>
        </div>
        <button class="btn sm" id="btnGPS">Toggle GPS</button>
        <button class="btn sm" id="btnRecenter">Recenter</button>
        <button class="btn sm" id="btnDemo">Demo</button>
      </div>
    </div>
  </div>

  <div class="wrap section" style="padding-top:18px;">
    <div class="row" style="align-items:flex-start;">
      <div>
        <div class="kicker">Explore</div>
        <div class="sp10"></div>
        <h1 class="h2">Homes near you</h1>
        <div class="sp10"></div>
        <p class="p">Browse houses within your radius. Tap a marker or a home card to see details and linked items.</p>
      </div>

      <div class="card soft pad" style="max-width: 420px;">
        <div class="h3">Radius</div>
        <div class="sp10"></div>
        <div class="range">
          <input id="radius" type="range" min="0.5" max="20" step="0.5" value="2" />
          <div class="val"><span id="radiusVal">2.0</span> mi</div>
        </div>
        <div class="sp10"></div>
        <div class="small">Tip: If you see “No homes found,” hit <b>Demo</b> to seed sample homes near the map center.</div>
      </div>
    </div>

    <div class="sp18"></div>

    <div class="split">
      <div class="map-shell">
        <div id="map"></div>
      </div>

      <div class="panel">
        <div class="tabs">
          <div class="tab" id="tabHomes" data-on="1">Homes</div>
          <div class="tab" id="tabLinks" data-on="0">Links</div>
        </div>

        <div class="panel-b" id="panelHomes">
          <div class="small muted2" style="margin-bottom:10px;">
            Nearby homes. Tap a card or marker to select. Open full details from the card.
          </div>
          <div class="list" id="homesList"></div>
          <div class="sp14"></div>
          <div class="empty hide" id="homesEmpty">
            <b>No homes found in range.</b><br/>
            Increase radius or click <b>Demo</b> to load sample homes.
          </div>
        </div>

        <div class="panel-b hide" id="panelLinks">
          <div class="small muted2" style="margin-bottom:10px;">
            Links for the selected home (materials, items, purchase links).
          </div>
          <div class="empty" id="linksEmpty">
            <b>No home selected.</b><br/>
            Select a home to see its linked items.
          </div>
          <div class="list hide" id="linksList"></div>
        </div>
      </div>
    </div>
  </div>

  <script>
    (function () {
      const DEFAULT = { lat: 36.15398, lng: -95.99277, zoom: 12 }; // Tulsa-ish fallback
      const state = {
        map: null,
        center: { ...DEFAULT },
        gpsOn: false,
        radiusMi: 2.0,
        markers: new Map(),
        selectedHouseId: null,
      };

      const $ = (id) => document.getElementById(id);

      const el = {
        btnGPS: $("btnGPS"),
        btnRecenter: $("btnRecenter"),
        btnDemo: $("btnDemo"),
        gpsDot: $("gpsDot"),
        gpsTxt: $("gpsTxt"),
        radius: $("radius"),
        radiusVal: $("radiusVal"),
        homesList: $("homesList"),
        homesEmpty: $("homesEmpty"),
        linksEmpty: $("linksEmpty"),
        linksList: $("linksList"),
        tabHomes: $("tabHomes"),
        tabLinks: $("tabLinks"),
        panelHomes: $("panelHomes"),
        panelLinks: $("panelLinks"),
      };

      function setTab(which) {
        const homesOn = which === "homes";
        el.tabHomes.dataset.on = homesOn ? "1" : "0";
        el.tabLinks.dataset.on = homesOn ? "0" : "1";
        el.panelHomes.classList.toggle("hide", !homesOn);
        el.panelLinks.classList.toggle("hide", homesOn);
      }

      function setGPSUI(on) {
        el.gpsTxt.textContent = on ? "on" : "off";
        el.gpsDot.classList.toggle("on", !!on);
      }

      function haversineMi(a, b) {
        const R = 3958.8; // miles
        const toRad = (d) => d * Math.PI / 180;
        const dLat = toRad(b.lat - a.lat);
        const dLon = toRad(b.lng - a.lng);
        const lat1 = toRad(a.lat);
        const lat2 = toRad(b.lat);
        const x = Math.sin(dLat / 2) ** 2 +
                  Math.cos(lat1) * Math.cos(lat2) * Math.sin(dLon / 2) ** 2;
        const c = 2 * Math.atan2(Math.sqrt(x), Math.sqrt(1 - x));
        return R * c;
      }

      function getVisibleHouses() {
        const all = (window.HomagioDB?.listHouses?.() || []);
        return all
          .filter(h => typeof h.lat === "number" && typeof h.lng === "number")
          .map(h => ({
            ...h,
            distMi: haversineMi(state.center, { lat: h.lat, lng: h.lng })
          }))
          .filter(h => h.distMi <= state.radiusMi)
          .sort((a,b) => a.distMi - b.distMi);
      }

      function markerIcon(houseId, label, selected) {
        return L.divIcon({
          className: "",
          html: `<div class="price-pin ${selected ? "sel" : ""}">
                  <span class="mini"></span>
                  <span>${label}</span>
                </div>`,
          iconSize: [1, 1],
          iconAnchor: [0, 0]
        });
      }

      function selectHouse(houseId, { pan = true, openPopup = true } = {}) {
        state.selectedHouseId = houseId;
        setTab("links");
        render();

        const house = window.HomagioDB?.getHouse?.(houseId);
        if (!house) return;

        if (pan && state.map) state.map.panTo([house.lat, house.lng], { animate: true });
        if (openPopup) {
          const mk = state.markers.get(houseId);
          if (mk) mk.openPopup();
        }
      }

      function renderHomesPanel(houses) {
        el.homesList.innerHTML = "";
        if (!houses.length) {
          el.homesEmpty.classList.remove("hide");
          return;
        }
        el.homesEmpty.classList.add("hide");

        for (const h of houses) {
          const div = document.createElement("div");
          div.className = "item-card";
          div.innerHTML = `
            <div class="item-top">
              <div>
                <div class="item-title">${HomagioCore.escapeHTML(h.name || "House")}</div>
                <div class="item-sub">
                  ${(h.address ? HomagioCore.escapeHTML(h.address) : "No address")}
                  • ${h.distMi.toFixed(1)} mi
                </div>
              </div>
              <div style="display:flex; gap:8px; flex-wrap:wrap; justify-content:flex-end;">
                <a class="btn sm" href="./house.html?id=${encodeURIComponent(h.id)}">Open</a>
                <button class="btn sm primary" data-sel="${h.id}">Select</button>
              </div>
            </div>
          `;
          div.querySelector('button[data-sel]')?.addEventListener("click", () => selectHouse(h.id));
          div.addEventListener("dblclick", () => selectHouse(h.id));
          el.homesList.appendChild(div);
        }
      }

      function renderLinksPanel() {
        const id = state.selectedHouseId;
        const house = id ? window.HomagioDB?.getHouse?.(id) : null;

        if (!house) {
          el.linksList.classList.add("hide");
          el.linksEmpty.classList.remove("hide");
          return;
        }

        const items = Array.isArray(house.items) ? house.items : [];
        const photos = Array.isArray(house.photos) ? house.photos : [];
        const photoById = new Map(photos.map(p => [p.id, p]));
        const linked = items.filter(it => (it.link && String(it.link).trim().length > 0));

        el.linksList.innerHTML = "";

        if (!linked.length) {
          el.linksList.classList.add("hide");
          el.linksEmpty.classList.remove("hide");
          el.linksEmpty.innerHTML = `
            <b>No linked items yet.</b><br/>
            Open this home and add items with purchase links.
            <div class="sp10"></div>
            <a class="btn sm primary" href="./house.html?id=${encodeURIComponent(house.id)}">Open ${HomagioCore.escapeHTML(house.name || "House")}</a>
          `;
          return;
        }

        el.linksEmpty.classList.add("hide");
        el.linksList.classList.remove("hide");

        for (const it of linked) {
          const p = it.photoId ? photoById.get(it.photoId) : null;

          const card = document.createElement("div");
          card.className = "item-card";
          card.innerHTML = `
            <div class="item-top">
              <div>
                <div class="item-title">${HomagioCore.escapeHTML(it.title || "Item")}</div>
                <div class="item-sub">
                  ${(it.category ? HomagioCore.escapeHTML(it.category) : "Uncategorized")}
                </div>
              </div>
              <div style="display:flex; gap:8px; align-items:center; flex-wrap:wrap; justify-content:flex-end;">
                <span class="badge">${HomagioCore.formatMoney(it.price || 0)}</span>
                <a class="btn sm primary" href="${HomagioCore.escapeHTML(it.link)}" target="_blank" rel="noopener noreferrer">Open link</a>
              </div>
            </div>

            ${p && p.url ? `
              <div class="sp10"></div>
              <div class="row" style="gap:10px;">
                <div style="flex:0 0 110px;">
                  <img src="${HomagioCore.escapeHTML(p.url)}" alt=""
                    style="width:110px;height:76px;object-fit:cover;border-radius:12px;border:1px solid rgba(15,23,42,.12);" />
                </div>
                <div class="small muted2">Linked photo</div>
              </div>
            ` : ``}
          `;
          el.linksList.appendChild(card);
        }
      }

      function renderMarkers(houses) {
        if (!state.map) return;
        for (const mk of state.markers.values()) state.map.removeLayer(mk);
        state.markers.clear();

        for (const h of houses) {
          const selected = h.id === state.selectedHouseId;
          const label = (h.distMi <= 0.05) ? "Here" : `${h.distMi.toFixed(1)} mi`;

          const mk = L.marker([h.lat, h.lng], {
            icon: markerIcon(h.id, label, selected),
            keyboard: false
          });

          mk.on("click", () => selectHouse(h.id, { pan: false, openPopup: true }));

          mk.bindPopup(`
            <div style="min-width:220px;">
              <div style="font-weight:900; margin-bottom:4px;">${HomagioCore.escapeHTML(h.name || "House")}</div>
              <div style="color:#475569; font-size:12px; margin-bottom:10px;">
                ${(h.address ? HomagioCore.escapeHTML(h.address) : "No address")}
                • ${h.distMi.toFixed(1)} mi
              </div>
              <div style="display:flex; gap:8px; flex-wrap:wrap;">
                <a class="btn sm" href="./house.html?id=${encodeURIComponent(h.id)}">Open</a>
                <button class="btn sm primary" onclick="(function(){ try{ window.__homagioSelect && window.__homagioSelect('${h.id}'); }catch(e){} })()">Select</button>
              </div>
            </div>
          `);

          mk.addTo(state.map);
          state.markers.set(h.id, mk);
        }
      }

      function render() {
        const houses = getVisibleHouses();
        renderHomesPanel(houses);
        renderMarkers(houses);
        renderLinksPanel();
      }

      function initMap() {
        if (!window.L) { setTimeout(initMap, 50); return; }

        state.map = L.map("map", { zoomControl: true, preferCanvas: true });

        L.tileLayer("https://{s}.basemaps.cartocdn.com/light_all/{z}/{x}/{y}{r}.png", {
          maxZoom: 19,
          attribution: "&copy; OpenStreetMap &copy; CARTO"
        }).addTo(state.map);

        state.map.setView([state.center.lat, state.center.lng], DEFAULT.zoom);

        window.__homagioSelect = (id) => selectHouse(id);
        render();
      }

      function recenter() {
        if (!state.map) return;
        state.map.setView([state.center.lat, state.center.lng], DEFAULT.zoom, { animate: true });
        render();
      }

      function enableGPS(on) {
        state.gpsOn = !!on;
        setGPSUI(state.gpsOn);

        if (!state.gpsOn) {
          HomagioCore.toast("GPS off", "Using map center instead of your device location.", "info", 2200);
          return;
        }

        if (!navigator.geolocation) {
          state.gpsOn = false;
          setGPSUI(false);
          HomagioCore.toast("GPS unavailable", "Your browser/device does not support geolocation.", "bad", 3000);
          return;
        }

        navigator.geolocation.getCurrentPosition(
          (pos) => {
            state.center = { lat: pos.coords.latitude, lng: pos.coords.longitude };
            HomagioCore.toast("GPS on", "Centered on your current location.", "good", 2200);
            recenter();
          },
          () => {
            state.gpsOn = false;
            setGPSUI(false);
            HomagioCore.toast("GPS blocked", "Allow location access to use GPS mode.", "bad", 3200);
          },
          { enableHighAccuracy: true, timeout: 9000, maximumAge: 5000 }
        );
      }

      function seedDemo() {
        const fn = window.HomagioDB?.seedDemoNear;
        if (typeof fn !== "function") {
          HomagioCore.toast("Demo unavailable", "HomagioDB.seedDemoNear not found.", "bad", 3200);
          return;
        }
        fn(state.center.lat, state.center.lng, true);
        HomagioCore.toast("Demo homes loaded", "Sample homes added near your center.", "good", 2400);
        setTab("homes");
        render();
      }

      document.addEventListener("DOMContentLoaded", () => {
        state.radiusMi = parseFloat(el.radius.value || "2") || 2.0;
        el.radiusVal.textContent = state.radiusMi.toFixed(1);

        el.radius.addEventListener("input", () => {
          state.radiusMi = parseFloat(el.radius.value || "2") || 2.0;
          el.radiusVal.textContent = state.radiusMi.toFixed(1);
          render();
        });

        el.tabHomes.addEventListener("click", () => setTab("homes"));
        el.tabLinks.addEventListener("click", () => setTab("links"));

        el.btnGPS.addEventListener("click", () => enableGPS(!state.gpsOn));
        el.btnRecenter.addEventListener("click", () => recenter());
        el.btnDemo.addEventListener("click", () => seedDemo());

        setGPSUI(false);
        setTab("homes");
        initMap();
      });
    })();
  </script>
</body>
</html>
