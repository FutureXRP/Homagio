<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
  <title>Homagio — Explore</title>
  <meta name="description" content="Explore Homagio homes nearby." />

  <link
    rel="stylesheet"
    href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"
    integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY="
    crossorigin=""
  />
  <script
    src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"
    integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo="
    crossorigin=""
  ></script>

  <meta name="color-scheme" content="light dark" />
  <style>
    :root{
      --bg0:#07090d;
      --bg1:#0b0f16;
      --card:#0f1623;
      --muted:#a9b4c7;
      --text:#eaf0ff;
      --line:rgba(255,255,255,.10);
      --blue:#2d6cdf;
      --blue2:#1f4fb0;
      --good:#27c7a8;
      --warn:#ffcc66;
      --bad:#ff5577;
      --r:18px;
    }
    *{box-sizing:border-box}
    body{
      margin:0;
      font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial;
      background: linear-gradient(180deg, var(--bg0), var(--bg1));
      color:var(--text);
      height:100vh;
      overflow:hidden;
    }
    a{color:inherit;text-decoration:none}

    .top{
      position:sticky; top:0; z-index:40;
      backdrop-filter: blur(10px);
      background: rgba(7,9,13,.72);
      border-bottom:1px solid var(--line);
    }
    .wrap{max-width:1400px;margin:0 auto;padding:14px 16px}
    .row{display:flex;gap:12px;align-items:center;justify-content:space-between;flex-wrap:wrap}
    .brand{display:flex;gap:10px;align-items:center}
    .logo{
      width:34px;height:34px;border-radius:12px;
      background: radial-gradient(circle at 30% 20%, rgba(255,255,255,.20), transparent 45%),
                  linear-gradient(180deg, rgba(45,108,223,.95), rgba(31,79,176,.95));
      box-shadow: 0 0 0 6px rgba(45,108,223,.18), 0 18px 40px rgba(0,0,0,.45);
    }
    .brand h1{font-size:14px;margin:0;letter-spacing:.3px}
    .brand p{margin:0;font-size:12px;color:var(--muted)}
    .nav{display:flex;gap:10px;align-items:center;flex-wrap:wrap}

    .btn{
      border:1px solid var(--line);
      background: rgba(255,255,255,.06);
      color:var(--text);
      padding:10px 12px;
      border-radius: 14px;
      font-size:13px;
      cursor:pointer;
      transition:.15s transform,.15s background,.15s border;
      display:inline-flex; gap:8px; align-items:center;
    }
    .btn:hover{transform: translateY(-1px); background: rgba(255,255,255,.10); border-color: rgba(255,255,255,.16)}
    .btn.primary{
      border:none;
      background: linear-gradient(180deg, rgba(45,108,223,.95), rgba(31,79,176,.95));
      box-shadow: 0 12px 30px rgba(45,108,223,.28);
    }

    .layout{
      display:grid;
      grid-template-columns: 1fr 380px;
      height: calc(100vh - 62px);
    }
    @media (max-width: 980px){
      .layout{grid-template-columns: 1fr}
      .side{position:absolute; right:10px; top:72px; width:min(92vw, 420px); height: calc(100vh - 86px); z-index:60}
    }

    #map{height:100%; width:100%}

    .side{
      border-left:1px solid var(--line);
      background: rgba(12,16,24,.75);
      backdrop-filter: blur(10px);
      display:flex;
      flex-direction:column;
      min-height:0;
    }
    .panelTop{
      padding:12px;
      border-bottom:1px solid var(--line);
      display:flex;
      gap:10px;
      align-items:center;
      justify-content:space-between;
    }
    .tabs{display:flex; gap:8px}
    .tab{
      padding:8px 10px;
      border-radius: 12px;
      border:1px solid var(--line);
      background: rgba(255,255,255,.04);
      font-size:12px;
      color: var(--muted);
      cursor:pointer;
    }
    .tab.active{
      color: var(--text);
      border-color: rgba(45,108,223,.55);
      background: rgba(45,108,223,.18);
    }
    .panelBody{
      padding:12px;
      overflow:auto;
      min-height:0;
    }
    .mini{
      font-size:12px;color:var(--muted);line-height:1.35
    }
    .homeCard{
      border:1px solid var(--line);
      background: rgba(0,0,0,.18);
      border-radius: 16px;
      padding:12px;
      margin-bottom:10px;
      cursor:pointer;
    }
    .homeCard:hover{background: rgba(0,0,0,.24); border-color: rgba(255,255,255,.16)}
    .homeCard .name{font-weight:800}
    .pill{
      display:inline-flex; align-items:center; gap:6px;
      font-size:11px; color:var(--muted);
      border:1px solid var(--line);
      padding:4px 8px;
      border-radius: 999px;
      background: rgba(255,255,255,.04);
      margin-top:8px;
    }
    .listTitle{
      font-weight:800;
      margin: 0 0 10px;
      font-size:13px;
    }

    .rangeRow{
      display:flex; gap:10px; align-items:center; margin-top:10px;
      border:1px solid var(--line);
      border-radius: 16px;
      padding:10px;
      background: rgba(255,255,255,.04);
    }
    input[type="range"]{width:100%}
    .stat{
      font-size:12px;
      color: var(--muted);
      margin-left:auto;
      white-space:nowrap;
    }

    .linkItem{
      border:1px solid var(--line);
      background: rgba(255,255,255,.04);
      border-radius: 14px;
      padding:10px;
      margin-bottom:8px;
    }
    .linkItem a{
      color: rgba(234,240,255,.95);
      text-decoration: underline;
      word-break: break-word;
    }

    /* nicer markers */
    .house-pin{
      width: 38px;
      height: 38px;
      border-radius: 14px;
      border: 2px solid rgba(255, 255, 255, 0.35);
      background:
        radial-gradient(circle at 30% 20%, rgba(255, 255, 255, 0.25), transparent 40%),
        linear-gradient(180deg, rgba(45, 108, 223, 0.95), rgba(31, 79, 176, 0.95));
      display: grid;
      place-items: center;
      box-shadow:
        0 0 0 6px rgba(45, 108, 223, 0.22),
        0 14px 34px rgba(0, 0, 0, 0.35);
    }
    .house-pin span{
      font-weight:900;
      font-size:12px;
      color: rgba(255,255,255,.95);
      transform: translateY(-.5px);
    }
  </style>
</head>
<body>
  <div class="top">
    <div class="wrap">
      <div class="row">
        <div class="brand">
          <div class="logo"></div>
          <div>
            <h1>Homagio</h1>
            <p>Explore nearby homes</p>
          </div>
        </div>

        <div class="nav">
          <a class="btn" href="./index.html">Home</a>
          <a class="btn" href="./my.html">My Houses</a>
          <button class="btn" id="btnGPS">GPS off</button>
          <button class="btn" id="btnRecenter">Recenter</button>
          <button class="btn primary" id="btnDemo">Demo</button>
        </div>
      </div>
    </div>
  </div>

  <div class="layout">
    <div id="map"></div>

    <aside class="side">
      <div class="panelTop">
        <div class="tabs">
          <div class="tab active" id="tabHomes">Homes</div>
          <div class="tab" id="tabLinks">Links</div>
        </div>
        <div class="mini" id="gpsStatus">GPS: off</div>
      </div>

      <div class="panelBody">
        <div id="panelHomes">
          <div class="mini">Homes near you. Tap a home card or marker to open details.</div>

          <div class="rangeRow">
            <div class="mini" style="min-width:56px">Radius</div>
            <input id="radius" type="range" min="1" max="25" step="1" value="2" />
            <div class="stat" id="radiusLabel">2 mi</div>
          </div>

          <div style="height:12px"></div>
          <div class="listTitle" id="homesTitle">Nearby</div>
          <div id="homes"></div>
          <div id="homesEmpty" class="mini" style="display:none;margin-top:10px">
            No homes found in range. Tap <b>Demo</b> to load sample homes.
          </div>
        </div>

        <div id="panelLinks" style="display:none">
          <div class="mini">Links for the selected home (materials, items, purchase links).</div>
          <div style="height:12px"></div>
          <div class="listTitle" id="linksTitle">No home selected</div>
          <div id="links"></div>
          <div id="linksEmpty" class="mini" style="display:block;margin-top:10px">
            Select a home to see its linked items.
          </div>
        </div>
      </div>
    </aside>
  </div>

  <script src="./assets/db.js"></script>
  <script>
    const DEFAULT = { lat: 36.1540, lng: -95.9928, zoom: 12 }; // Tulsa-ish default
    const $ = (id) => document.getElementById(id);

    let map = null;
    let markers = [];
    let gpsWatchId = null;
    let userPos = null;
    let selectedHouseId = null;

    function milesToMeters(mi){ return mi * 1609.344; }

    function distMeters(aLat,aLng,bLat,bLng){
      // haversine
      const R = 6371000;
      const toRad = (d)=>d*Math.PI/180;
      const dLat = toRad(bLat-aLat);
      const dLng = toRad(bLng-aLng);
      const sa = Math.sin(dLat/2)**2 + Math.cos(toRad(aLat))*Math.cos(toRad(bLat))*Math.sin(dLng/2)**2;
      return 2*R*Math.asin(Math.sqrt(sa));
    }

    function makeIcon(letter){
      return L.divIcon({
        className: "",
        html: `<div class="house-pin"><span>${letter}</span></div>`,
        iconSize: [38,38],
        iconAnchor: [19,38],
        popupAnchor: [0,-34]
      });
    }

    function clearMarkers(){
      markers.forEach(m => m.remove());
      markers = [];
    }

    function safeInvalidate(){
      try{ map && map.invalidateSize(); } catch(e){}
    }

    function setTabs(which){
      const homes = $("panelHomes");
      const links = $("panelLinks");
      const th = $("tabHomes");
      const tl = $("tabLinks");
      if(which === "links"){
        homes.style.display="none";
        links.style.display="block";
        th.classList.remove("active");
        tl.classList.add("active");
      } else {
        homes.style.display="block";
        links.style.display="none";
        tl.classList.remove("active");
        th.classList.add("active");
      }
    }

    $("tabHomes").addEventListener("click", ()=>setTabs("homes"));
    $("tabLinks").addEventListener("click", ()=>setTabs("links"));

    function renderLinksPanel(house){
      const linksEl = $("links");
      linksEl.innerHTML = "";

      if(!house){
        $("linksTitle").textContent = "No home selected";
        $("linksEmpty").style.display="block";
        return;
      }

      $("linksTitle").textContent = house.name + " — links";
      const items = Array.isArray(house.items) ? house.items : [];
      const withLinks = items.filter(it => (it.link || "").trim().length > 0);

      if(withLinks.length === 0){
        $("linksEmpty").style.display="block";
        $("linksEmpty").textContent = "No linked items yet for this home.";
        return;
      }

      $("linksEmpty").style.display="none";
      withLinks.forEach(it=>{
        const div = document.createElement("div");
        div.className = "linkItem";
        div.innerHTML = `
          <div style="font-weight:800">${escapeHtml(it.title || "Item")}</div>
          <div class="mini" style="margin-top:6px">
            ${(it.brand||it.finish||it.category) ? `${escapeHtml([it.category,it.brand,it.finish].filter(Boolean).join(" • "))}<br/>` : ""}
            <a href="${escapeAttr(it.link)}" target="_blank" rel="noopener">${escapeHtml(it.link)}</a>
          </div>
        `;
        linksEl.appendChild(div);
      });
    }

    function renderHouses(){
      const center = userPos || DEFAULT;
      const radiusMi = Number($("radius").value || 2);
      $("radiusLabel").textContent = radiusMi + " mi";

      const houses = HomagioDB.listHouses()
        .filter(h => typeof h.lat === "number" && typeof h.lng === "number")
        .map(h => {
          const d = distMeters(center.lat, center.lng, h.lat, h.lng);
          return { ...h, _dist: d };
        })
        .filter(h => h._dist <= milesToMeters(radiusMi))
        .sort((a,b)=>a._dist - b._dist);

      $("homesTitle").textContent = userPos ? "Nearby (GPS)" : "Nearby (default)";
      $("homesEmpty").style.display = houses.length ? "none" : "block";

      // Markers
      clearMarkers();
      houses.forEach((h, idx)=>{
        const letter = (h.name || "H").trim().slice(0,1).toUpperCase();
        const m = L.marker([h.lat, h.lng], { icon: makeIcon(letter) }).addTo(map);
        m.on("click", ()=>{
          selectedHouseId = h.id;
          setTabs("links");
          renderLinksPanel(HomagioDB.getHouse(h.id));
        });
        m.bindPopup(`<b>${escapeHtml(h.name)}</b><br/>${escapeHtml(h.address || "")}<br/><a href="./house.html?id=${encodeURIComponent(h.id)}">Open</a>`);
        markers.push(m);
      });

      // Cards
      const el = $("homes");
      el.innerHTML = "";
      houses.forEach((h)=>{
        const mi = h._dist / 1609.344;
        const remaining = (Number(h.budgetTotal)||0) - (Number(h.budgetSpent)||0);
        const card = document.createElement("div");
        card.className = "homeCard";
        card.innerHTML = `
          <div class="name">${escapeHtml(h.name)}</div>
          <div class="pill">• ${(h.tier||"Free")} • ${(h.style||"Style")}</div>
          <div class="mini" style="margin-top:8px">
            ${escapeHtml(h.address || "(no address)") }<br/>
            ${mi.toFixed(1)} mi away • Remaining $${Number(remaining||0).toLocaleString(undefined,{maximumFractionDigits:0})}
          </div>
          <div style="margin-top:10px; display:flex; gap:8px; flex-wrap:wrap">
            <a class="btn" style="padding:8px 10px" href="./house.html?id=${encodeURIComponent(h.id)}">Open</a>
            <button class="btn" style="padding:8px 10px" data-links="${h.id}">Links</button>
            <button class="btn" style="padding:8px 10px" data-fly="${h.id}">Fly to</button>
          </div>
        `;
        card.addEventListener("click", (e)=>{
          const fly = e.target && e.target.getAttribute && e.target.getAttribute("data-fly");
          const links = e.target && e.target.getAttribute && e.target.getAttribute("data-links");
          if(fly){
            e.stopPropagation();
            const hh = HomagioDB.getHouse(fly);
            if(hh) map.setView([hh.lat, hh.lng], 15, { animate:true });
            return;
          }
          if(links){
            e.stopPropagation();
            selectedHouseId = links;
            setTabs("links");
            renderLinksPanel(HomagioDB.getHouse(links));
            return;
          }
          map.setView([h.lat, h.lng], 15, { animate:true });
        });
        el.appendChild(card);
      });

      // Keep links panel in sync if a home is selected
      if(selectedHouseId){
        renderLinksPanel(HomagioDB.getHouse(selectedHouseId));
      }
    }

    function setGPS(on){
      if(on){
        if(!navigator.geolocation){
          $("gpsStatus").textContent = "GPS: unavailable";
          return;
        }
        $("gpsStatus").textContent = "GPS: searching…";
        $("btnGPS").textContent = "GPS on";
        gpsWatchId = navigator.geolocation.watchPosition(
          (pos)=>{
            userPos = { lat: pos.coords.latitude, lng: pos.coords.longitude };
            $("gpsStatus").textContent = "GPS: on";
            map.setView([userPos.lat, userPos.lng], 13, { animate:true });
            renderHouses();
          },
          (err)=>{
            console.warn(err);
            $("gpsStatus").textContent = "GPS: blocked";
            $("btnGPS").textContent = "GPS off";
            userPos = null;
            if(gpsWatchId){ navigator.geolocation.clearWatch(gpsWatchId); gpsWatchId=null; }
            renderHouses();
          },
          { enableHighAccuracy:true, maximumAge: 8000, timeout: 10000 }
        );
      } else {
        $("btnGPS").textContent = "GPS off";
        $("gpsStatus").textContent = "GPS: off";
        userPos = null;
        if(gpsWatchId){ navigator.geolocation.clearWatch(gpsWatchId); gpsWatchId=null; }
        map.setView([DEFAULT.lat, DEFAULT.lng], DEFAULT.zoom);
        renderHouses();
      }
    }

    $("btnGPS").addEventListener("click", ()=>{
      if(gpsWatchId) setGPS(false);
      else setGPS(true);
    });

    $("btnRecenter").addEventListener("click", ()=>{
      const c = userPos || DEFAULT;
      map.setView([c.lat, c.lng], userPos ? 13 : DEFAULT.zoom, { animate:true });
    });

    $("btnDemo").addEventListener("click", ()=>{
      // seed near current view center so "nearby" always shows
      const c = map.getCenter();
      HomagioDB.seedDemoNear(c.lat, c.lng, true);
      renderHouses();
      setTabs("homes");
    });

    $("radius").addEventListener("input", renderHouses);

    function escapeHtml(str){
      return String(str || "")
        .replaceAll("&","&amp;")
        .replaceAll("<","&lt;")
        .replaceAll(">","&gt;")
        .replaceAll('"',"&quot;")
        .replaceAll("'","&#039;");
    }
    function escapeAttr(str){
      return String(str || "").replaceAll('"',"&quot;");
    }

    // Init map
    HomagioDB.ensure();

    map = L.map("map", { zoomControl: true });
    // Lighter tiles (your earlier preference)
    L.tileLayer("https://{s}.basemaps.cartocdn.com/light_all/{z}/{x}/{y}{r}.png", {
      maxZoom: 20,
      attribution: '&copy; OpenStreetMap &copy; CARTO'
    }).addTo(map);

    map.setView([DEFAULT.lat, DEFAULT.lng], DEFAULT.zoom);
    window.addEventListener("resize", safeInvalidate);

    // Initial render
    renderHouses();
    safeInvalidate();
  </script>
</body>
</html>
