<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
  <title>Homagio — My Houses</title>
  <meta name="description" content="Homagio owner dashboard — create and manage houses." />
  <meta name="color-scheme" content="dark" />
  <style>
    :root{
      --bg0:#07090d;
      --bg1:#0b0f16;
      --card:#0f1623;
      --muted:#a9b4c7;
      --text:#eaf0ff;
      --line:rgba(255,255,255,.10);
      --blue:#2d6cdf;
      --blue2:#1f4fb0;
      --good:#27c7a8;
      --warn:#ffcc66;
      --bad:#ff5577;
      --r:18px;
    }
    *{box-sizing:border-box}
    body{
      margin:0;
      font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial;
      background: radial-gradient(1200px 600px at 25% -10%, rgba(45,108,223,.30), transparent 60%),
                  radial-gradient(900px 500px at 90% 0%, rgba(39,199,168,.20), transparent 60%),
                  linear-gradient(180deg, var(--bg0), var(--bg1));
      color:var(--text);
    }
    a{color:inherit;text-decoration:none}
    .top{
      position:sticky; top:0; z-index:20;
      backdrop-filter: blur(10px);
      background: rgba(7,9,13,.72);
      border-bottom:1px solid var(--line);
    }
    .wrap{max-width:1100px;margin:0 auto;padding:16px}
    .row{display:flex;gap:12px;align-items:center;justify-content:space-between;flex-wrap:wrap}
    .brand{display:flex;gap:10px;align-items:center}
    .logo{
      width:34px;height:34px;border-radius:12px;
      background: radial-gradient(circle at 30% 20%, rgba(255,255,255,.20), transparent 45%),
                  linear-gradient(180deg, rgba(45,108,223,.95), rgba(31,79,176,.95));
      box-shadow: 0 0 0 6px rgba(45,108,223,.18), 0 18px 40px rgba(0,0,0,.45);
    }
    .brand h1{font-size:14px;margin:0;letter-spacing:.3px}
    .brand p{margin:0;font-size:12px;color:var(--muted)}
    .nav{display:flex;gap:10px;align-items:center;flex-wrap:wrap}
    .btn{
      border:1px solid var(--line);
      background: rgba(255,255,255,.06);
      color:var(--text);
      padding:10px 12px;
      border-radius: 14px;
      font-size:13px;
      cursor:pointer;
      transition:.15s transform,.15s background,.15s border;
    }
    .btn:hover{transform: translateY(-1px); background: rgba(255,255,255,.10); border-color: rgba(255,255,255,.16)}
    .btn.primary{
      border:none;
      background: linear-gradient(180deg, rgba(45,108,223,.95), rgba(31,79,176,.95));
      box-shadow: 0 12px 30px rgba(45,108,223,.28);
    }
    .grid{
      display:grid;
      grid-template-columns: 1.2fr .8fr;
      gap:14px;
      padding:18px 16px 40px;
      max-width:1100px;
      margin:0 auto;
    }
    @media (max-width: 980px){
      .grid{grid-template-columns:1fr}
    }
    .card{
      background: linear-gradient(180deg, rgba(255,255,255,.06), rgba(255,255,255,.03));
      border:1px solid var(--line);
      border-radius: var(--r);
      box-shadow: 0 18px 55px rgba(0,0,0,.35);
      overflow:hidden;
    }
    .card .hd{padding:14px 14px 10px;border-bottom:1px solid var(--line)}
    .card .hd .t{font-weight:700;font-size:14px;margin:0}
    .card .hd .s{margin:6px 0 0;font-size:12px;color:var(--muted);line-height:1.35}
    .card .bd{padding:14px}
    .houseList{display:flex;flex-direction:column;gap:10px}
    .house{
      display:flex; gap:12px; align-items:flex-start; justify-content:space-between;
      padding:12px;
      border-radius: 16px;
      border:1px solid var(--line);
      background: rgba(0,0,0,.18);
      cursor:pointer;
    }
    .house:hover{border-color: rgba(255,255,255,.18); background: rgba(0,0,0,.24)}
    .house .name{font-weight:700}
    .pill{
      display:inline-flex; align-items:center; gap:6px;
      font-size:11px; color:var(--muted);
      border:1px solid var(--line);
      padding:4px 8px;
      border-radius: 999px;
      background: rgba(255,255,255,.04);
      margin-top:6px;
    }
    .house .meta{font-size:12px;color:var(--muted);line-height:1.35;margin-top:6px}
    .kpis{display:grid;grid-template-columns:1fr 1fr 1fr;gap:10px;margin-top:10px}
    .kpi{
      border:1px solid var(--line);
      background: rgba(255,255,255,.04);
      padding:10px;
      border-radius: 16px;
    }
    .kpi .l{font-size:11px;color:var(--muted)}
    .kpi .v{font-size:14px;font-weight:800;margin-top:6px}
    .form{display:flex;flex-direction:column;gap:10px}
    label{font-size:12px;color:var(--muted)}
    input, select{
      width:100%;
      padding:12px 12px;
      border-radius: 14px;
      border:1px solid var(--line);
      background: rgba(0,0,0,.22);
      color: var(--text);
      outline:none;
    }
    input:focus, select:focus{border-color: rgba(45,108,223,.65); box-shadow: 0 0 0 4px rgba(45,108,223,.15)}
    .small{font-size:12px;color:var(--muted);line-height:1.35}
    .status{
      font-size:12px;
      color: var(--muted);
      margin-top:8px;
    }
    .status.good{color: rgba(39,199,168,.95)}
    .status.bad{color: rgba(255,85,119,.95)}
    .row2{display:flex;gap:10px}
    .row2 > *{flex:1}
    .danger{border-color: rgba(255,85,119,.35)!important}
  </style>
</head>
<body>
  <div class="top">
    <div class="wrap">
      <div class="row">
        <div class="brand">
          <div class="logo"></div>
          <div>
            <h1>Homagio</h1>
            <p>Owner dashboard</p>
          </div>
        </div>
        <div class="nav">
          <a class="btn" href="./index.html">Home</a>
          <a class="btn" href="./explore.html">Explore</a>
          <button class="btn" id="btnReset">Reset</button>
          <button class="btn primary" id="btnDemo">Demo Data</button>
        </div>
      </div>
    </div>
  </div>

  <div class="grid">
    <div class="card">
      <div class="hd">
        <div class="t">Your homes</div>
        <div class="s">Tap a home to open it. This is localStorage MVP — later we’ll swap to Firebase accounts.</div>
      </div>
      <div class="bd">
        <div id="kpis" class="kpis"></div>
        <div style="height:12px"></div>
        <div id="list" class="houseList"></div>
        <div id="empty" class="small" style="display:none;margin-top:10px">
          No homes yet. Create one on the right, or tap <b>Demo Data</b>.
        </div>
      </div>
    </div>

    <div class="card">
      <div class="hd">
        <div class="t">Add a new house</div>
        <div class="s">Uses an <b>address</b> and auto-geocodes to lat/lng for Explore.</div>
      </div>
      <div class="bd">
        <div class="form">
          <div>
            <label>House name</label>
            <input id="name" placeholder="e.g., Blair Family Home" />
          </div>

          <div class="row2">
            <div>
              <label>Style</label>
              <input id="style" placeholder="e.g., Modern, Farmhouse" />
            </div>
            <div>
              <label>Tier</label>
              <select id="tier">
                <option>Free</option>
                <option>Premium</option>
              </select>
            </div>
          </div>

          <div>
            <label>Address</label>
            <input id="address" placeholder="123 Main St, Tulsa, OK" />
            <div class="small" style="margin-top:6px">
              Tip: include city/state for best results.
            </div>
          </div>

          <div class="row2">
            <div>
              <label>Budget (Total)</label>
              <input id="budgetTotal" type="number" min="0" step="1" placeholder="25000" />
            </div>
            <div>
              <label>Spent</label>
              <input id="budgetSpent" type="number" min="0" step="1" placeholder="6400" />
            </div>
          </div>

          <button class="btn primary" id="create">Create House</button>
          <div id="status" class="status"></div>

          <div class="small" style="margin-top:10px">
            When you open a house, you can add photos, link materials/items to photos, and track budget.
          </div>
        </div>
      </div>
    </div>
  </div>

  <script src="./assets/db.js"></script>
  <script>
    const $ = (id) => document.getElementById(id);

    function money(n){
      const v = Number(n || 0);
      return "$" + v.toLocaleString(undefined, { maximumFractionDigits: 0 });
    }

    function setStatus(text, type){
      const el = $("status");
      el.textContent = text || "";
      el.className = "status" + (type ? " " + type : "");
    }

    async function geocodeAddress(address){
      const url = "https://nominatim.openstreetmap.org/search?format=json&q=" + encodeURIComponent(address);
      const res = await fetch(url, {
        headers: {
          "Accept": "application/json"
        }
      });
      if(!res.ok) throw new Error("Geocode request failed");
      const data = await res.json();
      if(!Array.isArray(data) || data.length === 0) return null;
      const best = data[0];
      return { lat: Number(best.lat), lng: Number(best.lon) };
    }

    function render(){
      const houses = HomagioDB.listHouses();

      // KPIs
      const total = houses.length;
      const totalBudget = houses.reduce((s,h)=>s + (Number(h.budgetTotal)||0), 0);
      const totalSpent = houses.reduce((s,h)=>s + (Number(h.budgetSpent)||0), 0);
      $("kpis").innerHTML = `
        <div class="kpi"><div class="l">Homes</div><div class="v">${total}</div></div>
        <div class="kpi"><div class="l">Budget</div><div class="v">${money(totalBudget)}</div></div>
        <div class="kpi"><div class="l">Spent</div><div class="v">${money(totalSpent)}</div></div>
      `;

      const list = $("list");
      list.innerHTML = "";
      $("empty").style.display = houses.length ? "none" : "block";

      houses.forEach((h)=>{
        const remaining = (Number(h.budgetTotal)||0) - (Number(h.budgetSpent)||0);
        const pill = h.tier === "Premium" ? "Premium" : "Free";
        const addr = h.address ? h.address : "(no address yet)";
        const hasCoords = (typeof h.lat === "number" && typeof h.lng === "number");

        const el = document.createElement("div");
        el.className = "house";
        el.innerHTML = `
          <div style="min-width:0">
            <div class="name">${escapeHtml(h.name)}</div>
            <div class="pill">• ${pill} • ${escapeHtml(h.style || "Style")}</div>
            <div class="meta">
              ${escapeHtml(addr)}<br/>
              ${hasCoords ? `Coords: ${h.lat.toFixed(5)}, ${h.lng.toFixed(5)}` : `<span style="color:rgba(255,204,102,.95)">No map coords yet</span>`}
            </div>
          </div>
          <div style="text-align:right">
            <div style="font-weight:800">${money(remaining)}</div>
            <div class="small">remaining</div>
            <div style="height:10px"></div>
            <button class="btn" data-del="${h.id}" title="Delete">Delete</button>
          </div>
        `;

        el.addEventListener("click", (e)=>{
          const delId = e.target && e.target.getAttribute && e.target.getAttribute("data-del");
          if (delId){
            e.stopPropagation();
            if(confirm("Delete this house?")){
              HomagioDB.deleteHouse(delId);
              render();
            }
            return;
          }
          window.location.href = "./house.html?id=" + encodeURIComponent(h.id);
        });

        list.appendChild(el);
      });
    }

    function escapeHtml(str){
      return String(str || "")
        .replaceAll("&","&amp;")
        .replaceAll("<","&lt;")
        .replaceAll(">","&gt;")
        .replaceAll('"',"&quot;")
        .replaceAll("'","&#039;");
    }

    $("btnReset").addEventListener("click", ()=>{
      if(confirm("Reset local Homagio data?")){
        localStorage.removeItem(HomagioDB._key);
        setStatus("Local data reset.", "good");
        render();
      }
    });

    $("btnDemo").addEventListener("click", ()=>{
      // Default seed location (Tulsa-ish)
      HomagioDB.seedDemoNear(36.1540, -95.9928, true);
      setStatus("Demo homes loaded.", "good");
      render();
    });

    $("create").addEventListener("click", async ()=>{
      setStatus("");

      const name = $("name").value.trim();
      const style = $("style").value.trim();
      const tier = $("tier").value;
      const address = $("address").value.trim();
      const budgetTotal = Number($("budgetTotal").value || 0);
      const budgetSpent = Number($("budgetSpent").value || 0);

      if(!name){
        $("name").classList.add("danger");
        setStatus("Please enter a house name.", "bad");
        return;
      } else {
        $("name").classList.remove("danger");
      }

      let coords = null;
      if(address){
        try{
          setStatus("Geocoding address…", "");
          coords = await geocodeAddress(address);
          if(!coords){
            setStatus("Could not find that address. House will still be created (no map pin yet).", "bad");
          } else {
            setStatus("Address found. Creating house…", "good");
          }
        } catch (e){
          console.warn(e);
          setStatus("Geocode failed. House will still be created (no map pin yet).", "bad");
        }
      } else {
        setStatus("No address entered. House will be created (no map pin yet).", "bad");
      }

      const created = HomagioDB.upsertHouse({
        name,
        style,
        tier,
        address,
        lat: coords ? coords.lat : null,
        lng: coords ? coords.lng : null,
        budgetTotal,
        budgetSpent,
        photos: [],
        items: []
      });

      $("name").value = "";
      $("style").value = "";
      $("address").value = "";
      $("budgetTotal").value = "";
      $("budgetSpent").value = "";

      render();
      setStatus("Created: " + created.name, "good");
      // Optional: jump straight into the new house
      window.location.href = "./house.html?id=" + encodeURIComponent(created.id);
    });

    // Init
    HomagioDB.ensure();
    render();
  </script>
</body>
</html>
